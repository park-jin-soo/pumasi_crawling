<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„ìš°ë¯¸ ì†Œí†µë°© í’ˆì•—ì´ ë§í¬ ìˆ˜ì§‘ê¸° V12.34</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #03c75a;
            --bg-color: #f5f6f7;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 24px;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .section-title {
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        textarea {
            width: 100% !important;
            min-height: 180px !important;
            padding: 12px;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 13px;
            margin-bottom: 10px;
            display: block;
            resize: vertical;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn.stop { background-color: #ff4d4f; }
        .btn:disabled { background-color: #ccc !important; cursor: not-allowed; }

        .log-area {
            width: 100%;
            height: 250px;
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 6px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }

        .info-text { font-size: 12px; color: #888; margin-top: 5px; }

        .collapsible {
            display: none;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .shared-members-toggle-row {
            display: flex;
            justify-content: flex-end;
            margin-top: 6px;
        }

        .shared-exclude-toolbar { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
        .shared-exclude-input { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px; }
        .shared-exclude-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
        .shared-exclude-table th, .shared-exclude-table td { border: 1px solid #eee; padding: 6px; text-align: left; }
        .btn.small { padding: 5px 10px; font-size: 11px; }
        .btn.outline { background: #fff; border: 1px solid #ccc; color: #333; }
    </style>
</head>

<body>

    <div class="container">
        <h1>ì†Œí†µë°© í’ˆì•—ì´ ë§í¬ ìˆ˜ì§‘ê¸° V12.34</h1>

        <div class="section">
            <span class="section-title">ì†Œí†µë°© í’ˆì•—ì´ ê³„ì • ì•„ì´ë”” ëª©ë¡</span>
            <div id="memberList" style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: #fafafa; font-size: 13px; max-height: 120px; overflow-y: auto; white-space: pre-wrap;"></div>
        </div>

        <div class="section" id="membersAdminSection" style="border: 2px solid #ff3b30;">
            <span class="section-title">íšŒì› ì•„ì´ë”” ê´€ë¦¬ (ë°©ì¥ ì „ìš©)</span>
            <div class="shared-exclude-toolbar">
                <button id="adminLoginBtn" class="btn small" style="background:#666" onclick="adminLogin()">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
                <button id="adminLogoutBtn" class="btn small outline" onclick="adminLogout()" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
                <input id="sharedMembersAddInput" class="shared-exclude-input" placeholder="ì¶”ê°€í•  ì•„ì´ë”” ì…ë ¥" />
                <button id="sharedMembersAddBtn" class="btn small" onclick="sharedMembersAdd()" disabled>ì¶”ê°€</button>
                <button class="btn small outline" onclick="sharedMembersRefresh()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="sharedMembersStatus" class="info-text">* íšŒì›ëª©ë¡ ë¡œë“œ ëŒ€ê¸° ì¤‘...</div>

            <div class="shared-members-toggle-row">
                <button id="sharedMembersToggleBtn" class="btn small outline" onclick="toggleSharedMembersList()">íšŒì›ëª©ë¡ í¼ì¹˜ê¸°</button>
            </div>

            <div id="sharedMembersCollapsible" class="collapsible">
                <table class="shared-exclude-table">
                    <thead>
                        <tr><th>ì•„ì´ë””</th><th>ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody id="sharedMembersTbody"></tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <span class="section-title">í’ˆì•—ì´ ì œì™¸ ìš”ì²­</span>
            <div class="shared-exclude-toolbar">
                <input id="sharedExcludeAddInput" class="shared-exclude-input" placeholder="ì•„ì´ë”” ë˜ëŠ” ìˆœë²ˆ" />
                <button class="btn small" onclick="sharedExcludeAdd()">ì¶”ê°€</button>
                <button class="btn small outline" onclick="sharedExcludeRefresh()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="sharedExcludeStatus" class="info-text">* ë¡œë”© ì¤‘...</div>
            <table class="shared-exclude-table">
                <tbody id="sharedExcludeTbody"></tbody>
            </table>
        </div>

        <div class="section">
            <span class="section-title">1. ì „ì¼ í’ˆì•—ì´ ìë£Œ í™•ì¸</span>
            <textarea id="prevDataInput" placeholder="ì–´ì œ ë§ˆì§€ë§‰ ê²°ê³¼ ë©”ì‹œì§€ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
            <div style="text-align: right;">
                <button id="applyBtn" class="btn" onclick="applyPrevData()" style="background-color: #666;">ìë£Œ ì ìš©</button>
            </div>
            <div id="prevDataStatus" class="info-text" style="color: #ff4d4f;">* íŒŒì‹± ì™„ë£Œ í›„ 'ìˆ˜ì§‘ ì‹œì‘' ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</div>
        </div>

        <div class="section">
            <span class="section-title">2. ìˆ˜ì§‘ ì„¤ì •</span>
            <div id="dateDisplay" style="font-weight:bold;">ë‚ ì§œ ë¡œë”© ì¤‘...</div>
        </div>

        <div style="display:flex; justify-content: center; gap:10px; margin-bottom: 20px;">
            <button id="startBtn" class="btn" onclick="startCollecting()" disabled>ğŸš€ ìˆ˜ì§‘ ì‹œì‘</button>
            <button id="stopBtn" class="btn stop" onclick="stopCollecting()" disabled>â¹ï¸ ì¤‘ì§€</button>
        </div>

        <div class="log-area" id="logArea"></div>
    </div>

    <script>
        let isRunning = false;
        let stopRequested = false;
        let blogIds = [];
        let isDataApplied = false;
        let isAdmin = false;

        const HARDCODED_IDS_ENCODED = [
            "bWVlbmE3Nw==", "bWVlbmExMjI1", "d2pkdGpkZG4wOTE=", "cmVhbG9vX3U=", "dWVvNzc=",
            "aGFlbWlsNDAy", "YXJpYXJpNzQ4Ng==", "Ymx1ZXBhbnRzMjc=", "NTIxb2h3NTIx",
            "cmVkcGFudHMyNw==", "aG9uZ2hvbmd3YW5uYQ==", "dmlzaW9uLWJlc3Q=", "Z2JoeTEwMA==",
            "d2hpdGU4MDU4", "c3R1ZHk4MDU4", "Y2xsYXJh", "cGhnNDQ2Ng==", "c2Vuc2VxdWVlbg==",
            "Z29kX2JsZXNzeW91NTU2NQ==", "aHNlNzI5", "aGktc29yYQ==", "bGlmZS1uZXh1czc5", "eXVsZF9kdW5n",
            "aGFwcHktc3BhY2Utc2FlbXRlcg==", "c3V5b3VuMTAyMw==", "ZGJma2Q5Mw==", "d2pkZGxhNDAy", "eW9vbnlfbW9tbXk=",
            "d29uczBfMA==", "bWN0aGF0MTMxMzEz", "c2luZ2NjbQ==", "bWFrZWNjbQ==", "dGhvbWFzLTgyNzI=",
            "cmlha29p", "YXRvbTA5MTIt", "ZmlsbG5nbw==", "YWh5b3VuZzEwMw==", "amluaS1yYW5n"
        ];

        const HARDCODED_IDS = HARDCODED_IDS_ENCODED.map(id => atob(id));
        const SHARED_DB = "https://pumasi-exclude-default-rtdb.firebaseio.com";

        function seoulNow() { return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" })); }
        
        function getWindowKey() {
            const now = seoulNow();
            const start = new Date(now);
            start.setHours(20, 0, 0, 0);
            if (now < start) start.setDate(start.getDate() - 1);
            return `${start.getFullYear()}${String(start.getMonth() + 1).padStart(2, '0')}${String(start.getDate()).padStart(2, '0')}`;
        }

        async function sharedMembersRefresh() {
            try {
                const res = await fetch(`${SHARED_DB}/members.json`);
                const data = await res.json();
                const items = Object.entries(data || {}).map(([key, v]) => ({ key, ...v }));
                blogIds = items.length > 0 ? items.map(x => x.blogId) : [...HARDCODED_IDS];
                document.getElementById('memberList').textContent = blogIds.map((id, i) => `${i + 1}. ${id}`).join('\n');
                document.getElementById('sharedMembersTbody').innerHTML = items.map(it => `<tr><td>${it.blogId}</td><td><button class="btn small stop" onclick="sharedMembersDelete('${it.key}')" ${isAdmin?'':'disabled'}>ì‚­ì œ</button></td></tr>`).join('');
                document.getElementById('sharedMembersStatus').textContent = `âœ… ${blogIds.length}ëª… ë¡œë“œë¨`;
            } catch (e) { blogIds = [...HARDCODED_IDS]; }
        }

        async function sharedMembersAdd() {
            const id = document.getElementById('sharedMembersAddInput').value.trim();
            if (!id) return;
            await fetch(`${SHARED_DB}/members.json`, { method: 'POST', body: JSON.stringify({ blogId: id, createdAt: Date.now() }) });
            document.getElementById('sharedMembersAddInput').value = '';
            sharedMembersRefresh();
        }

        async function sharedMembersDelete(key) {
            if (confirm('ì‚­ì œí• ê¹Œìš”?')) {
                await fetch(`${SHARED_DB}/members/${key}.json`, { method: 'DELETE' });
                sharedMembersRefresh();
            }
        }

        function adminLogin() { if (prompt('ë¹„ë°€ë²ˆí˜¸') === '7702') { isAdmin = true; document.getElementById('adminLogoutBtn').style.display='inline'; document.getElementById('sharedMembersAddBtn').disabled=false; sharedMembersRefresh(); } }
        function adminLogout() { isAdmin = false; location.reload(); }

        function toggleSharedMembersList() {
            const wrap = document.getElementById("sharedMembersCollapsible");
            const btn = document.getElementById("sharedMembersToggleBtn");
            const isExpanded = wrap.style.display === "block";
            wrap.style.display = isExpanded ? "none" : "block";
            btn.textContent = isExpanded ? "íšŒì›ëª©ë¡ í¼ì¹˜ê¸°" : "íšŒì›ëª©ë¡ ì ‘ê¸°";
        }

        async function sharedExcludeRefresh() {
            const res = await fetch(`${SHARED_DB}/excludes/${getWindowKey()}.json`);
            const data = await res.json();
            const items = Object.entries(data || {}).map(([key, v]) => ({ key, ...v }));
            document.getElementById('sharedExcludeTbody').innerHTML = items.map(it => `<tr><td>${it.blogId}</td><td><button class="btn small stop" onclick="sharedExcludeDelete('${it.key}')">ì‚­ì œ</button></td></tr>`).join('');
            document.getElementById('sharedExcludeStatus').textContent = `âœ… ì œì™¸ìš”ì²­ ${items.length}ëª…`;
        }

        async function sharedExcludeDelete(key) {
            await fetch(`${SHARED_DB}/excludes/${getWindowKey()}/${key}.json`, { method: 'DELETE' });
            sharedExcludeRefresh();
        }

        async function sharedExcludeAdd() {
            const val = document.getElementById('sharedExcludeAddInput').value.trim();
            const ids = parseExcludedIds(val, true);
            for (const id of ids) {
                await fetch(`${SHARED_DB}/excludes/${getWindowKey()}.json`, { method: 'POST', body: JSON.stringify({ blogId: id, createdAt: Date.now() }) });
            }
            document.getElementById('sharedExcludeAddInput').value = '';
            sharedExcludeRefresh();
        }

        function parseExcludedIds(text, useMapping) {
            if (!text) return [];
            return text.split(/\n|,/).map(l => {
                let line = l.trim();
                let cleaned = line.replace(/^\d+\.\s*/, '').trim();
                let match = cleaned.match(/^([a-zA-Z0-9_-]+)(?:\((\d+)\))?$/);
                if (match) return { id: match[1], count: match[2] ? parseInt(match[2]) : 1 };
                if (useMapping && /^\d+$/.test(line)) {
                    let n = parseInt(line);
                    if (n >= 1 && n <= blogIds.length) return { id: blogIds[n - 1], count: 1 };
                }
                return null;
            }).filter(Boolean);
        }

        function getServiceExcludes(text) {
            const adminId = "brain_1018";
            const svcStart = text.indexOf("ê¸ˆì¼ ë´‰ì‚¬ ê³„ì •");
            let oldSvc = [];
            if (svcStart !== -1) {
                const nextSectionMarkers = ["ê¸ˆì¼ ì œì™¸ìš”ì²­", "ê¸ˆì¼ í’ˆì•—ì´ ê³„ì •", "ì°¸ì—¬ì•„ì´ë””"];
                let svcEnd = text.length;
                for (const m of nextSectionMarkers) {
                    const idx = text.indexOf(m, svcStart + 8);
                    if (idx !== -1 && idx < svcEnd) svcEnd = idx;
                }
                oldSvc = parseExcludedIds(text.substring(svcStart + 8, svcEnd), false).map(item => ({ id: item.id, count: item.count + 1 }));
            }
            const pumStart = text.indexOf("ê¸ˆì¼ í’ˆì•—ì´ ê³„ì •");
            let newSvc = [];
            if (pumStart !== -1) {
                const nextSectionMarkers = ["ì°¸ì—¬ì•„ì´ë””", "ì´ ì°¸ì—¬ ì•„ì´ë””"];
                let pumEnd = text.length;
                for (const m of nextSectionMarkers) {
                    const idx = text.indexOf(m, pumStart + 10);
                    if (idx !== -1 && idx < pumEnd) pumEnd = idx;
                }
                newSvc = parseExcludedIds(text.substring(pumStart + 10, pumEnd), false).map(item => ({ id: item.id, count: 1 }));
            }
            let combined = [...oldSvc, ...newSvc].filter(item => item.id !== adminId);
            const seen = new Set();
            return combined.filter(el => { const isDuplicate = seen.has(el.id); seen.add(el.id); return !isDuplicate; });
        }

        // [ìˆ˜ì •] ë²„íŠ¼ í™œì„±í™” ë¡œì§ ê°•í™”
        function applyPrevData() {
            if (document.getElementById('prevDataInput').value.length < 5) {
                alert("ìë£Œê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.");
                return;
            }
            isDataApplied = true;
            const statusEl = document.getElementById('prevDataStatus');
            statusEl.textContent = "âœ… íŒŒì‹± ì™„ë£Œ (ìˆ˜ì§‘ ì‹œì‘ ê°€ëŠ¥)";
            statusEl.style.color = "green";
            
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.style.backgroundColor = "#03c75a";
            startBtn.style.cursor = "pointer";
            
            appendLog("âœ… ì „ì¼ ìë£Œê°€ ì •ìƒ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        async function startCollecting() {
            const now = seoulNow();
            const adminId = "brain_1018";
            const svcExclObjects = getServiceExcludes(document.getElementById('prevDataInput').value);
            const svcExclIds = svcExclObjects.map(o => o.id);
            
            let reqExcl = [];
            try {
                const res = await fetch(`${SHARED_DB}/excludes/${getWindowKey()}.json`);
                const data = await res.json();
                reqExcl = Object.values(data || {}).map(v => v.blogId).filter(id => id !== adminId);
            } catch (e) {}

            const finalExclIds = [...new Set([...svcExclIds, ...reqExcl])];
            const targets = blogIds.filter(id => !finalExclIds.includes(id));

            isRunning = true; stopRequested = false;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            const log = document.getElementById('logArea');
            log.innerHTML = `ğŸš€ ìˆ˜ì§‘ ì‹œì‘ (íƒ€ê²Ÿ: ${targets.length}ëª…)\n`;
            log.textContent += `âš ï¸ ì œì™¸(ë´‰ì‚¬): ${svcExclObjects.length}ëª…\n\n`;

            const sTime = new Date(now); sTime.setDate(sTime.getDate() - 1); sTime.setHours(20, 0, 0, 0);
            const eTime = new Date(now); eTime.setHours(20, 0, 0, 0);

            const cLinks = []; const cIds = [];
            const proxies = ["https://corsproxy.io/?", "https://api.allorigins.win/raw?url="];

            for (let i = 0; i < targets.length; i++) {
                if (stopRequested) break;
                const bid = targets[i];
                log.textContent += `[${i + 1}/${targets.length}] ${bid} í™•ì¸... `;
                
                let ok = false;
                for (const p of proxies) {
                    if (ok) break;
                    try {
                        const rssUrl = `https://rss.blog.naver.com/${bid}.xml?t=${Date.now()}`;
                        const res = await fetch(p + encodeURIComponent(rssUrl));
                        const txt = await res.text();
                        const xml = new DOMParser().parseFromString(txt, "text/xml");
                        const items = Array.from(xml.getElementsByTagName("item"));
                        const valid = items.filter(it => {
                            const d = new Date(it.getElementsByTagName("pubDate")[0]?.textContent);
                            return d >= sTime && d < eTime;
                        }).slice(0, 3);

                        if (valid.length > 0) {
                            valid.forEach(v => cLinks.push(v.getElementsByTagName("link")[0].textContent.replace("blog.naver.com", "m.blog.naver.com")));
                            if (!cIds.includes(bid)) cIds.push(bid);
                            log.textContent += `âœ… ${valid.length}ê°œ\n`;
                            ok = true;
                        } else {
                            log.textContent += `ğŸ” ì—†ìŒ\n`;
                            ok = true;
                        }
                    } catch (e) {}
                }
                log.scrollTop = log.scrollHeight;
                await new Promise(r => setTimeout(r, 1000));
            }

            if (cLinks.length > 0) downloadFiles(cLinks, cIds, svcExclObjects, reqExcl);
            isRunning = false; document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            log.textContent += `\nâœ… ì‘ì—… ì™„ë£Œ`;
        }

        function downloadFiles(links, ids, svcObjects, req) {
            const now = seoulNow();
            const dateStr = getWindowKey();
            const adminId = "brain_1018";
            const dispIds = ids.filter(i => i !== adminId);
            const dispReq = req.filter(i => i !== adminId);
            const dispSvc = svcObjects.filter(o => o.id !== adminId);

            const blob1 = new Blob([links.join('\n')], { type: 'text/plain' });
            const a1 = document.createElement('a'); a1.href = URL.createObjectURL(blob1); a1.download = `ë§í¬ìˆ˜ì§‘${dateStr}.txt`; a1.click();

            let res = `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›” ${now.getDate()}ì¼ ì°¸ì—¬ì•„ì´ë””\n`;
            res += `ì´ ì°¸ì—¬ : ${dispIds.length}ê°œ / ë´‰ì‚¬ : ${dispSvc.length}ê°œ\n\n`;
            res += `ê¸ˆì¼ ë´‰ì‚¬ ê³„ì •\n`;
            if (dispSvc.length > 0) {
                dispSvc.forEach((o, i) => { res += `${i + 1}. ${o.count > 1 ? `${o.id}(${o.count})` : o.id}\n`; });
            } else { res += "(ì—†ìŒ)\n"; }
            res += "\nê¸ˆì¼ ì œì™¸ìš”ì²­\n" + (dispReq.length ? dispReq.map((id, i) => `${i + 1}. ${id}`).join('\n') : "(ì—†ìŒ)") + "\n\n";
            res += "ê¸ˆì¼ í’ˆì•—ì´ ê³„ì •\n" + dispIds.map((id, i) => `${i + 1}. ${id}`).join('\n');

            const blob2 = new Blob([res], { type: 'text/plain' });
            const a2 = document.createElement('a'); a2.href = URL.createObjectURL(blob2); a2.download = `${dateStr}ì°¸ì—¬ì•„ì´ë””.txt`; a2.click();
        }

        function stopCollecting() { stopRequested = true; }
        function appendLog(m) { const log = document.getElementById('logArea'); log.textContent += m + "\n"; log.scrollTop = log.scrollHeight; }

        window.onload = () => {
            document.getElementById('dateDisplay').textContent = `ğŸ“… ìˆ˜ì§‘ ê¸°ì¤€: ${seoulNow().toISOString().split('T')[0]}`;
            sharedMembersRefresh();
            sharedExcludeRefresh();
        };
    </script>
</body>

</html>
