<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì±„ìš°ë¯¸ ì†Œí†µë°© í’ˆì•—ì´ ë§í¬ ìˆ˜ì§‘ê¸° (HTML ë²„ì „)</title>
    <!-- SheetJS for Excel reading -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #03c75a;
            --bg-color: #f5f6f7;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 20px;
            line-height: 1.3;
            word-break: keep-all;
        }

        .section {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        /* Admin member-management section highlight */
        #membersAdminSection {
            border: 2px solid #ff3b30; /* red */
        }

        .section-title {
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="file"] {
            font-size: 14px;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn.stop {
            background-color: #ff4d4f;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .log-area {
            width: 100%;
            height: 300px;
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 6px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }

        .info-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .member-list {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            background: #fafafa;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 180px;
            overflow-y: auto;
        }

        .shared-exclude-toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .shared-exclude-input {
            flex: 1;
            min-width: 0;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 13px;
            box-sizing: border-box;
        }

        .shared-exclude-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 8px;
            table-layout: fixed;
        }

        .shared-exclude-table th,
        .shared-exclude-table td {
            border: 1px solid #eee;
            padding: 6px 4px;
            text-align: left;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shared-exclude-table th {
            background: #fafafa;
            color: #666;
        }

        .collapsible {
            display: none;
        }

        .shared-members-toggle-row {
            display: flex;
            justify-content: flex-end;
            margin-top: 6px;
        }

        .shared-exclude-actions {
            display: flex;
            gap: 6px;
        }

        .shared-members-status {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }

        .btn.small {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
        }

        .btn.gray {
            background-color: #666;
        }

        .btn.outline {
            background: #fff;
            border: 1px solid #ccc;
            color: #333;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” (ì•„ì´í° 15 Pro: 393px) */
        @media screen and (max-width: 480px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 15px;
                border-radius: 8px;
            }

            h1 {
                font-size: 18px;
                margin-bottom: 15px;
            }

            .section {
                padding: 10px;
                margin-bottom: 12px;
            }

            .section-title {
                font-size: 13px;
                margin-bottom: 8px;
            }

            .info-text {
                font-size: 11px;
                line-height: 1.4;
            }

            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .btn.small {
                padding: 6px 8px;
                font-size: 11px;
                white-space: nowrap;
            }

            .shared-exclude-toolbar {
                gap: 6px;
                margin-bottom: 6px;
            }

            .shared-exclude-input {
                padding: 8px;
                font-size: 12px;
            }

            .shared-exclude-table {
                font-size: 11px;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .shared-exclude-table thead,
            .shared-exclude-table tbody {
                display: table;
                width: 100%;
                table-layout: fixed;
            }

            .shared-exclude-table th,
            .shared-exclude-table td {
                padding: 5px 3px;
                font-size: 11px;
            }

            .shared-exclude-table th:nth-child(1),
            .shared-exclude-table td:nth-child(1) {
                width: 40% !important;
            }

            .shared-exclude-table th:nth-child(2),
            .shared-exclude-table td:nth-child(2) {
                width: 30% !important;
            }

            .shared-exclude-table th:nth-child(3),
            .shared-exclude-table td:nth-child(3) {
                width: 30% !important;
            }

            .shared-exclude-actions {
                gap: 4px;
                flex-wrap: wrap;
            }

            .shared-exclude-actions .btn.small {
                padding: 5px 8px;
                font-size: 10px;
            }

            .log-area {
                height: 250px;
                font-size: 11px;
                padding: 8px;
            }

            .member-list {
                font-size: 12px;
                padding: 8px;
                max-height: 150px;
            }

            textarea {
                font-size: 12px !important;
                padding: 8px !important;
            }

            .row {
                gap: 6px;
                flex-wrap: wrap;
            }

            .shared-members-status {
                font-size: 11px;
            }
        }

        /* ë§¤ìš° ì‘ì€ í™”ë©´ (ì•„ì´í° SE ë“±) */
        @media screen and (max-width: 375px) {
            h1 {
                font-size: 16px;
            }

            .btn.small {
                padding: 5px 6px;
                font-size: 10px;
            }

            .shared-exclude-table th,
            .shared-exclude-table td {
                padding: 4px 2px;
                font-size: 10px;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ì†Œí†µë°© í’ˆì•—ì´ ë§í¬ ìˆ˜ì§‘ê¸° V12.19</h1>

        <!-- Member List -->
        <div class="section">
            <span class="section-title">ì†Œí†µë°© í’ˆì•—ì´ ê³„ì • ì•„ì´ë”” ëª©ë¡</span>
            <div id="memberList" class="member-list"></div>
        </div>

        <!-- Shared Members (Everyone) -->
        <div class="section" id="membersAdminSection">
            <span class="section-title">íšŒì› ì•„ì´ë”” ê´€ë¦¬ (ë°©ì¥ ê´€ë¦¬ììš©)</span>
            <div class="info-text" style="margin-bottom: 8px;">
                * ì—¬ê¸°ì„œ ì¶”ê°€/ì‚­ì œí•œ ëª©ë¡ì´ <strong>ìˆ˜ì§‘ ëŒ€ìƒ(ì „ì²´ íšŒì›)</strong>ì´ ë©ë‹ˆë‹¤. (ëª¨ë“  ì‚¬ìš©ì ê³µìœ )<br>
                * ì…ë ¥: ì•„ì´ë”” ì—¬ëŸ¬ ê°œ ê°€ëŠ¥ (ì½¤ë§ˆ/ì¤„ë°”ê¿ˆ) ì˜ˆ) <strong>dbfkd9, wjddla402</strong>
            </div>

            <div class="shared-exclude-toolbar">
                <button id="adminLoginBtn" class="btn small gray" onclick="adminLogin()">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
                <button id="adminLogoutBtn" class="btn small outline" onclick="adminLogout()" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
                <input id="sharedMembersAddInput" class="shared-exclude-input"
                    placeholder="ì¶”ê°€í•  ì•„ì´ë”” ì…ë ¥ (ì˜ˆ: dbfkd9, wjddla402)" />
                <button id="sharedMembersAddBtn" class="btn small" onclick="sharedMembersAdd()" disabled>ì¶”ê°€</button>
                <button class="btn small outline" onclick="sharedMembersRefresh()">ìƒˆë¡œê³ ì¹¨</button>
                <button id="sharedMembersSeedBtn" class="btn small gray" onclick="sharedMembersSeedFromHardcoded()" disabled>ì´ˆê¸°ëª©ë¡ ì—…ë¡œë“œ</button>
            </div>
            <div id="sharedMembersStatus" class="shared-members-status">* íšŒì›ëª©ë¡ ë¡œë“œ ì¤‘...</div>

            <div class="shared-members-toggle-row">
                <button id="sharedMembersToggleBtn" class="btn small outline" onclick="toggleSharedMembersList()">íšŒì›ëª©ë¡ í¼ì¹˜ê¸°</button>
            </div>

            <div id="sharedMembersCollapsible" class="collapsible">
                <table class="shared-exclude-table">
                    <thead>
                        <tr>
                            <th style="width: 55%;">ì•„ì´ë””</th>
                            <th style="width: 25%;">ë“±ë¡ì‹œê°(ì„œìš¸)</th>
                            <th style="width: 20%;">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="sharedMembersTbody">
                        <tr>
                            <td colspan="3" style="color:#888;">(ì—°ë™ í›„ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Shared Exclude Requests (Everyone) -->
        <div class="section">
            <span class="section-title">í’ˆì•—ì´ ì œì™¸ ìš”ì²­ (ìë™ ì ìš©)</span>
            <div class="info-text" style="margin-bottom: 8px;">
                * ì—¬ê¸° ëª©ë¡ì€ <strong>ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ê³µìœ </strong>ë©ë‹ˆë‹¤. <br>
                * ì ìš© ë²”ìœ„: <strong>ê¸ˆì¼ 20:00 ~ ìµì¼ 20:00</strong> ê¸°ì¤€ì˜ â€œì˜¤ëŠ˜ í’ˆì•—ì´â€ ì œì™¸ìš”ì²­
            </div>

            <div class="shared-exclude-toolbar">
                <input id="sharedExcludeAddInput" class="shared-exclude-input"
                    placeholder="ì œì™¸í•  ì•„ì´ë”” ë˜ëŠ” ê³„ì •ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 26 ë˜ëŠ” dbfkd9)" />
                <button id="sharedExcludeAddBtn" class="btn small" onclick="sharedExcludeAdd()">ì¶”ê°€</button>
                <button id="sharedExcludeRefreshBtn" class="btn small outline" onclick="sharedExcludeRefresh()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="info-text" id="sharedExcludeStatus">* ì œì™¸ ëª©ë¡ ë¡œë“œ ì¤‘... (ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì œì™¸ ìš”ì²­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤)</div>

            <table class="shared-exclude-table">
                <thead>
                    <tr>
                        <th style="width: 55%;">ì•„ì´ë””</th>
                        <th style="width: 25%;">ë“±ë¡ì‹œê°(ì„œìš¸)</th>
                        <th style="width: 20%;">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="sharedExcludeTbody">
                    <tr>
                        <td colspan="3" style="color:#888;">(ì—°ë™ í›„ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤)</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Previous Day Data Input -->
        <div class="section">
            <span class="section-title">1. ì „ì¼ í’ˆì•—ì´ ìë£Œ í™•ì¸</span>
            <div class="info-text" style="margin-bottom: 5px;">
                ì†Œí†µë°©ì˜ ë§ˆì§€ë§‰ í’ˆì•—ì´ì™„ë£Œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•˜ì—¬ ì•„ë˜ ì°½ì— ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”
            </div>
            <textarea id="prevDataInput" rows="5" placeholder="ì—¬ê¸°ì— ì–´ì œ ì™„ë£Œí•œ ë‚´ì—­ì„ ì…ë ¥í•˜ì„¸ìš”..."
                style="width: 100%; padding: 10px; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;"></textarea>

            <div class="row" style="margin-top: 10px; justify-content: flex-end;">
                <button id="applyBtn" class="btn" onclick="applyPrevData()" style="background-color: #666;">ìë£Œ
                    ì ìš©</button>
            </div>
            <div class="info-text" id="prevDataStatus" style="color: #ff4d4f;">* ìë£Œ ì…ë ¥ í›„ 'ìë£Œ ì ìš©' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </div>
        </div>

        <!-- Date & Settings -->
        <div class="section">
            <span class="section-title">2. ìˆ˜ì§‘ ì„¤ì •</span>
            <div class="row" style="margin-bottom: 10px;">
                <span>ğŸ“… ìˆ˜ì§‘ ê¸°ì¤€:</span>
                <strong id="dateDisplay"></strong>
                <span style="font-size: 12px; color: #888;">(ì˜¤ëŠ˜)</span>
            </div>
            <div class="row">
                <span>ìˆ˜ì§‘ ê°œìˆ˜: <strong>3ê°œ</strong> (ê³ ì •)</span>
            </div>
            <div class="info-text">
                * ìˆ˜ì§‘ ë²”ìœ„: ì–´ì œ 20:00 ~ ì˜¤ëŠ˜ 20:00<br>
            </div>
        </div>

        <!-- Controls -->
        <div class="row" style="justify-content: center; margin-bottom: 20px;">
            <button id="startBtn" class="btn" onclick="startCollecting()" disabled style="background-color: #ccc;">ğŸš€ ìˆ˜ì§‘
                ì‹œì‘</button>
            <button id="stopBtn" class="btn stop" onclick="stopCollecting()" disabled>â¹ï¸ ì¤‘ì§€</button>
        </div>

        <!-- Logs -->
        <div class="section-title">ë¡œê·¸</div>
        <div id="logArea" class="log-area"></div>
    </div>

    <script>
        let isRunning = false;
        let stopRequested = false;
        let blogIds = [];
        let isDataApplied = false;

        // Obfuscated Blog IDs (Base64 Encoded)
        // To add new IDs, ask the assistant: "Add [ID] to the list"
        const HARDCODED_IDS_ENCODED = [
            "bWVlbmE3Nw==", "bWVlbmExMjI1",
            "d2pkdGpkZG4wOTE=", "cmVhbG9vX3U=", "dWVvNzc=",
            "aGFlbWlsNDAy", "YXJpYXJpNzQ4Ng==", "Ymx1ZXBhbnRzMjc=", "NTIxb2h3NTIx",
            "cmVkcGFudHMyNw==", "aG9uZ2hvbmd3YW5uYQ==", "dmlzaW9uLWJlc3Q=", "Z2JoeTEwMA==",
            "d2hpdGU4MDU4", "c3R1ZHk4MDU4", "Y2xsYXJh", "cGhnNDQ2Ng==", "c2Vuc2VxdWVlbg==",
            "Z29kX2JsZXNzeW91NTU2NQ==", "aHNlNzI5", "aGktc29yYQ==", "bGlmZS1uZXh1czc5", "eXVsZF9kdW5n",
            "aGFwcHktc3BhY2Utc2FlbXRlcg==", "c3V5b3VuMTAyMw==", "ZGJma2Q5Mw==", "d2pkZGxhNDAy", "eW9vbnlfbW9tbXk=",
            "d29uczBfMA==", "bWN0aGF0MTMxMzEz", "c2luZ2NjbQ==", "bWFrZWNjbQ==", "dGhvbWFzLTgyNzI=",
            "cmlha29p", "YXRvbTA5MTIt", "ZmlsbG5nbw==", "YWh5b3VuZzEwMw==", "amluaS1yYW5n"
        ];

        // Decode IDs at runtime
        // Note: Using a Set to automatically remove duplicates (e.g. ppofamily125)
        const HARDCODED_IDS = [...new Set(HARDCODED_IDS_ENCODED.map(id => atob(id)))];
        blogIds = [...HARDCODED_IDS];

        // ë§ˆìŠ¤í„° ì•„ì´ë”” ê³„ì • ëª©ë¡ (ë§í¬ ìˆ˜ì§‘ì€ í•˜ì§€ë§Œ ì°¸ì—¬ì•„ì´ë”” íŒŒì¼ì—ì„œëŠ” ì œì™¸)
        const MASTER_IDS = ["brain_1018"];

        /**
         * Shared Exclude Storage (Firebase Realtime Database)
         * - Create Firebase project -> Realtime Database -> Rules:
         *     { "rules": { ".read": true, ".write": true } }
         * - Set DB url below (no trailing slash), ex: https://YOUR-PROJECT-ID-default-rtdb.asia-southeast1.firebasedatabase.app
         */
        const SHARED_EXCLUDE_DB_URL = "https://pumasi-exclude-default-rtdb.firebaseio.com"; // Firebase Realtime DB URL

        function isSharedExcludeEnabled() {
            return typeof SHARED_EXCLUDE_DB_URL === "string" && SHARED_EXCLUDE_DB_URL.trim().startsWith("https://");
        }

        // --- Admin Gate (Member management only) ---
        let isAdmin = false;
        const ADMIN_PIN_ENC = "NzcwMg=="; // base64("7702")
        let isMembersListExpanded = false;

        function adminPinMatches(pin) {
            try { return String(pin || "") === atob(ADMIN_PIN_ENC); } catch { return false; }
        }

        function setAdminMode(on) {
            isAdmin = !!on;
            const loginBtn = document.getElementById("adminLoginBtn");
            const logoutBtn = document.getElementById("adminLogoutBtn");
            const addInp = document.getElementById("sharedMembersAddInput");
            const addBtn = document.getElementById("sharedMembersAddBtn");
            const seedBtn = document.getElementById("sharedMembersSeedBtn");
            const st = document.getElementById("sharedMembersStatus");

            if (loginBtn) loginBtn.style.display = isAdmin ? "none" : "inline-block";
            if (logoutBtn) logoutBtn.style.display = isAdmin ? "inline-block" : "none";
            if (addInp) addInp.disabled = !isAdmin;
            if (addBtn) addBtn.disabled = !isAdmin;
            if (seedBtn) seedBtn.disabled = !isAdmin;
            if (st && !st.textContent.includes("íšŒì›ëª©ë¡")) {
                st.textContent = isAdmin ? "âœ… ê´€ë¦¬ì ê¶Œí•œ í™œì„±í™”ë¨ (íšŒì›ê´€ë¦¬ ê°€ëŠ¥)" : "ğŸ”’ ê´€ë¦¬ì ë¡œê·¸ì¸ í•„ìš” (íšŒì›ê´€ë¦¬ ì ê¸ˆ)";
            }
            
            // Update button states in the member list table
            const tbody = document.getElementById("sharedMembersTbody");
            if (tbody) {
                tbody.querySelectorAll('.shared-members-edit-btn, .shared-members-remove-btn').forEach(btn => {
                    if (isAdmin) {
                        btn.removeAttribute('disabled');
                    } else {
                        btn.setAttribute('disabled', 'disabled');
                    }
                });
            }
        }

        function adminLogin() {
            const pin = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (pin === null) return;
            if (!adminPinMatches(pin.trim())) {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            setAdminMode(true);
        }

        function adminLogout() {
            setAdminMode(false);
        }

        function setMembersListExpanded(expanded) {
            isMembersListExpanded = !!expanded;
            const wrap = document.getElementById("sharedMembersCollapsible");
            const btn = document.getElementById("sharedMembersToggleBtn");
            if (wrap) wrap.style.display = isMembersListExpanded ? "block" : "none";
            if (btn) btn.textContent = isMembersListExpanded ? "íšŒì›ëª©ë¡ ì ‘ê¸°" : "íšŒì›ëª©ë¡ í¼ì¹˜ê¸°";
        }

        function toggleSharedMembersList() {
            setMembersListExpanded(!isMembersListExpanded);
        }

        function seoulNow() {
            // Convert "now" to Seoul time reliably
            const s = new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" });
            return new Date(s);
        }

        function getTodayWindowKey(nowSeoul = seoulNow()) {
            // Window: 20:00 ~ next day 20:00
            const start = new Date(nowSeoul);
            start.setHours(20, 0, 0, 0);
            if (nowSeoul < start) start.setDate(start.getDate() - 1);
            const y = start.getFullYear();
            const m = String(start.getMonth() + 1).padStart(2, "0");
            const d = String(start.getDate()).padStart(2, "0");
            return `${y}${m}${d}`; // e.g. 20251218 (window start date)
        }

        function getSeoulDateKey(d = seoulNow()) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${y}${m}${day}`;
        }

        function formatSeoul(ts) {
            try {
                const dt = new Date(ts);
                return dt.toLocaleString("ko-KR", { timeZone: "Asia/Seoul", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
            } catch {
                return "";
            }
        }

        function renderMemberList() {
            const el = document.getElementById('memberList');
            if (!el) return;
            el.textContent = blogIds.map((id, idx) => `${idx + 1}. ${id}`).join("\n");
        }

        // ---- Shared Members (Firebase) ----
        async function sharedMembersFetchMap() {
            if (!isSharedExcludeEnabled()) return {};
            const url = `${SHARED_EXCLUDE_DB_URL}/members.json`;
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return (await res.json()) || {};
        }

        async function sharedMembersUpsert(keyOrNull, blogId) {
            if (!isSharedExcludeEnabled()) throw new Error("shared storage not configured");
            const payload = { blogId, updatedAt: Date.now() };
            if (!keyOrNull) payload.createdAt = Date.now();

            if (!keyOrNull) {
                const res = await fetch(`${SHARED_EXCLUDE_DB_URL}/members.json`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            }

            const res = await fetch(`${SHARED_EXCLUDE_DB_URL}/members/${keyOrNull}.json`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        async function sharedMembersDelete(key) {
            if (!isSharedExcludeEnabled()) throw new Error("shared storage not configured");
            const res = await fetch(`${SHARED_EXCLUDE_DB_URL}/members/${key}.json`, { method: "DELETE" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
        }

        function sharedMembersRenderRows(items) {
            const tbody = document.getElementById("sharedMembersTbody");
            if (!tbody) return;

            if (!items || items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="color:#888;">(íšŒì›ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤ â†’ í•˜ë“œì½”ë”© ëª©ë¡ìœ¼ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤)</td></tr>`;
                return;
            }

            tbody.innerHTML = items.map(it => {
                const esc = (s) => String(s).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;");
                const disabledAttr = isAdmin ? "" : "disabled";
                const keyEscaped = esc(it.key);
                return `
                    <tr data-key="${keyEscaped}">
                        <td><strong>${esc(it.blogId)}</strong></td>
                        <td style="color:#666;">${esc(formatSeoul(it.createdAt || it.updatedAt || ""))}</td>
                        <td>
                            <div class="shared-exclude-actions">
                                <button class="btn small outline shared-members-edit-btn" data-key="${keyEscaped}" ${disabledAttr}>ìˆ˜ì •</button>
                                <button class="btn small stop shared-members-remove-btn" data-key="${keyEscaped}" ${disabledAttr}>ì‚­ì œ</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join("");

            // Add event listeners to buttons
            tbody.querySelectorAll('.shared-members-edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const key = this.getAttribute('data-key');
                    if (key) sharedMembersEdit(key);
                });
            });

            tbody.querySelectorAll('.shared-members-remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const key = this.getAttribute('data-key');
                    if (key) sharedMembersRemove(key);
                });
            });
        }

        async function sharedMembersRefresh() {
            const st = document.getElementById("sharedMembersStatus");

            if (!isSharedExcludeEnabled()) {
                blogIds = [...HARDCODED_IDS];
                renderMemberList();
                if (st) st.textContent = `âš ï¸ ì €ì¥ì†Œ ë¯¸ì—°ê²° â†’ í•˜ë“œì½”ë”© ëª©ë¡ ì‚¬ìš© (ì´ ${blogIds.length}ëª…)`;
                sharedMembersRenderRows([]);
                return;
            }

            if (st) st.textContent = "â³ íšŒì›ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            try {
                const m = await sharedMembersFetchMap();
                const items = Object.entries(m).map(([key, v]) => ({ key, ...(v || {}) }))
                    .filter(x => x.blogId)
                    .sort((a, b) => (a.blogId || "").localeCompare(b.blogId || ""));

                sharedMembersRenderRows(items);
                blogIds = items.length > 0
                    ? [...new Set(items.map(x => x.blogId))]
                    : [...HARDCODED_IDS];

                renderMemberList();
                if (st) st.textContent = `âœ… íšŒì›ëª©ë¡ ì ìš© ì™„ë£Œ: ${blogIds.length}ëª… (DB ${items.length}ëª…${items.length === 0 ? ", í•˜ë“œì½”ë”© fallback" : ""})`;
            } catch (e) {
                blogIds = [...HARDCODED_IDS];
                renderMemberList();
                sharedMembersRenderRows([]);
                if (st) st.textContent = `âŒ íšŒì›ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ â†’ í•˜ë“œì½”ë”© ëª©ë¡ ì‚¬ìš©: ${e.message}`;
            }
        }

        async function sharedMembersAdd() {
            if (!isAdmin) { alert("ê´€ë¦¬ì ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
            const inp = document.getElementById("sharedMembersAddInput");
            if (!inp) return;
            const raw = (inp.value || "").trim();
            if (!raw) return;

            const st = document.getElementById("sharedMembersStatus");
            const normalized = raw.replaceAll(",", "\n");
            const ids = normalized.split("\n").map(s => s.trim()).filter(Boolean);
            const uniq = [...new Set(ids)];

            const valid = uniq.filter(x => /^[a-zA-Z0-9_-]{1,30}$/.test(x));
            if (valid.length === 0) { alert("ì•„ì´ë””ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ë¬¸/ìˆ«ì/_/- ë§Œ ê°€ëŠ¥)"); return; }
            if (!isSharedExcludeEnabled()) { alert("ì €ì¥ì†Œê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (DB URL í™•ì¸)"); return; }

            try {
                if (st) st.textContent = `â³ íšŒì› ì¶”ê°€ì¤‘... (${valid.length}ëª…)`;
                for (const id of valid) await sharedMembersUpsert(null, id);
                inp.value = "";
                await sharedMembersRefresh();
            } catch (e) {
                alert(`íšŒì› ì¶”ê°€ ì‹¤íŒ¨: ${e.message}`);
            }
        }

        async function sharedMembersEdit(key) {
            if (!isAdmin) { alert("ê´€ë¦¬ì ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
            const newVal = prompt("ìˆ˜ì •í•  ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (newVal === null) return;
            const id = (newVal || "").trim();
            if (!/^[a-zA-Z0-9_-]{1,30}$/.test(id)) { alert("ì•„ì´ë”” í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
            try {
                await sharedMembersUpsert(key, id);
                await sharedMembersRefresh();
            } catch (e) {
                alert(`ìˆ˜ì • ì‹¤íŒ¨: ${e.message}`);
            }
        }

        async function sharedMembersRemove(key) {
            if (!isAdmin) { alert("ê´€ë¦¬ì ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
            const ok = confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”? (ìˆ˜ì§‘ ëŒ€ìƒì—ì„œ ì œê±°ë©ë‹ˆë‹¤)");
            if (!ok) return;
            try {
                await sharedMembersDelete(key);
                await sharedMembersRefresh();
            } catch (e) {
                alert(`ì‚­ì œ ì‹¤íŒ¨: ${e.message}`);
            }
        }

        async function sharedMembersSeedFromHardcoded() {
            if (!isAdmin) { alert("ê´€ë¦¬ì ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
            if (!isSharedExcludeEnabled()) { alert("ì €ì¥ì†Œê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (DB URL í™•ì¸)"); return; }
            const ok = confirm(`í•˜ë“œì½”ë”© ê¸°ë³¸ ëª©ë¡(${HARDCODED_IDS.length}ëª…)ì„ DBì— ì—…ë¡œë“œí• ê¹Œìš”?\n(ì¤‘ë³µì€ ìë™ìœ¼ë¡œ ì €ì¥ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)`); 
            if (!ok) return;
            const st = document.getElementById("sharedMembersStatus");
            try {
                if (st) st.textContent = `â³ ì´ˆê¸°ëª©ë¡ ì—…ë¡œë“œì¤‘... (${HARDCODED_IDS.length}ëª…)`;
                for (const id of HARDCODED_IDS) await sharedMembersUpsert(null, id);
                await sharedMembersRefresh();
            } catch (e) {
                alert(`ì´ˆê¸°ëª©ë¡ ì—…ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
            }
        }

        async function sharedExcludeFetchMap(windowKey) {
            if (!isSharedExcludeEnabled()) return {};
            const url = `${SHARED_EXCLUDE_DB_URL}/excludes/${windowKey}.json`;
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return (await res.json()) || {};
        }

        async function sharedExcludeUpsert(windowKey, keyOrNull, blogId) {
            if (!isSharedExcludeEnabled()) throw new Error("shared storage not configured");
            const payload = { blogId, updatedAt: Date.now() };
            if (!keyOrNull) payload.createdAt = Date.now();

            if (!keyOrNull) {
                const res = await fetch(`${SHARED_EXCLUDE_DB_URL}/excludes/${windowKey}.json`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json(); // { name: key }
            }

            const res = await fetch(`${SHARED_EXCLUDE_DB_URL}/excludes/${windowKey}/${keyOrNull}.json`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        async function sharedExcludeDelete(windowKey, key) {
            if (!isSharedExcludeEnabled()) throw new Error("shared storage not configured");
            const res = await fetch(`${SHARED_EXCLUDE_DB_URL}/excludes/${windowKey}/${key}.json`, { method: "DELETE" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
        }

        async function sharedExcludeDeleteWindow(windowKey) {
            if (!isSharedExcludeEnabled()) throw new Error("shared storage not configured");
            const res = await fetch(`${SHARED_EXCLUDE_DB_URL}/excludes/${windowKey}.json`, { method: "DELETE" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
        }

        function sharedExcludeRenderRows(items) {
            const tbody = document.getElementById("sharedExcludeTbody");
            if (!tbody) return;

            if (!items || items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="color:#888;">(ê¸ˆì¼ ì œì™¸ ìš”ì²­ ì—†ìŒ)</td></tr>`;
                return;
            }

            tbody.innerHTML = items.map(it => {
                const esc = (s) => String(s).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;");
                return `
                    <tr data-key="${esc(it.key)}">
                        <td><strong>${esc(it.blogId)}</strong></td>
                        <td style="color:#666;">${esc(formatSeoul(it.createdAt || it.updatedAt || ""))}</td>
                        <td>
                            <div class="shared-exclude-actions">
                                <button class="btn small outline" onclick="sharedExcludeEdit('${esc(it.key)}')">ìˆ˜ì •</button>
                                <button class="btn small stop" onclick="sharedExcludeRemove('${esc(it.key)}')">ì‚­ì œ</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join("");
        }

        async function sharedExcludeRefresh() {
            const st = document.getElementById("sharedExcludeStatus");
            const now = seoulNow();
            const windowKey = getTodayWindowKey(now);

            if (!isSharedExcludeEnabled()) {
                if (st) st.textContent = "âš ï¸ ì €ì¥ì†Œ ë¯¸ì—°ê²° â†’ ì œì™¸ ëª©ë¡ì´ ë‹¤ë¥¸ ì‚¬ìš©ìì™€ ê³µìœ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Firebase URL ì„¤ì • í•„ìš”)";
                sharedExcludeRenderRows([]);
                return;
            }

            if (st) st.textContent = `â³ ê³µìœ  ì œì™¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (ì°½ í‚¤: ${windowKey})`;
            try {
                const m = await sharedExcludeFetchMap(windowKey);
                const items = Object.entries(m).map(([key, v]) => ({ key, ...(v || {}) }))
                    .filter(x => x.blogId)
                    .sort((a, b) => (b.createdAt || b.updatedAt || 0) - (a.createdAt || a.updatedAt || 0));

                sharedExcludeRenderRows(items);
                if (st) {
                    if (items.length > 0) {
                        st.textContent = `âœ… ê³µìœ  ì œì™¸ ëª©ë¡ ë¡œë“œ ì™„ë£Œ: ${items.length}ëª… (ëª¨ë“  ì‚¬ìš©ìì™€ ê³µìœ ë¨, ì°½ í‚¤: ${windowKey})`;
                    } else {
                        st.textContent = `âœ… ê³µìœ  ì œì™¸ ëª©ë¡ ë¡œë“œ ì™„ë£Œ: 0ëª… (ê¸ˆì¼ ì œì™¸ ìš”ì²­ ì—†ìŒ, ì°½ í‚¤: ${windowKey})`;
                    }
                }
            } catch (e) {
                sharedExcludeRenderRows([]);
                if (st) st.textContent = `âŒ ê³µìœ  ì œì™¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${e.message} (ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì œì™¸ ìš”ì²­ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)`;
            }
        }

        async function sharedExcludeAutoPurgeIfDue() {
            // NOTE: Static HTML can't run server-side cron.
            // This runs only when someone opens/keeps the page open.
            const now = seoulNow();
            const hh = now.getHours();
            const mm = now.getMinutes();

            // Daily at 21:00 Seoul: purge the current windowKey list once per day.
            const todayKey = getSeoulDateKey(now);
            const last = localStorage.getItem("sharedExcludeLastAutoPurge") || "";

            // Strictly at/after 21:00 Seoul
            if (hh > 21 || (hh === 21 && mm >= 0)) {
                if (last !== todayKey) {
                    const windowKey = getTodayWindowKey(now);
                    const st = document.getElementById("sharedExcludeStatus");
                    try {
                        if (st) st.textContent = `â³ 21:00 ìë™ì •ë¦¬ ì§„í–‰ì¤‘... (ì°½ í‚¤: ${windowKey})`;
                        await sharedExcludeDeleteWindow(windowKey);
                        localStorage.setItem("sharedExcludeLastAutoPurge", todayKey);
                        await sharedExcludeRefresh();
                        if (st) st.textContent = `âœ… 21:00 ìë™ì •ë¦¬ ì™„ë£Œ (ì°½ í‚¤: ${windowKey})`;
                    } catch (e) {
                        // Don't hard-fail UI
                        if (st) st.textContent = `âš ï¸ 21:00 ìë™ì •ë¦¬ ì‹¤íŒ¨: ${e.message}`;
                    }
                }
            }
        }

        function scheduleSharedExcludeDailyPurge() {
            // Best-effort client-side scheduler for 21:00 Seoul
            const now = seoulNow();
            const next = new Date(now);
            next.setHours(21, 0, 0, 0);
            if (now >= next) next.setDate(next.getDate() + 1);
            const ms = next.getTime() - now.getTime();

            setTimeout(async () => {
                await sharedExcludeAutoPurgeIfDue();
                // Then every 24h
                setInterval(sharedExcludeAutoPurgeIfDue, 24 * 60 * 60 * 1000);
            }, ms);
        }

        async function sharedExcludeAdd() {
            const inp = document.getElementById("sharedExcludeAddInput");
            if (!inp) return;
            const v = (inp.value || "").trim();
            if (!v) return;

            // Allow comma-separated bulk input: "1,2,17" or "dbfkd9, wjddla402"
            // Also supports newline separated values.
            const normalized = v.replaceAll(",", "\n");
            const parsedAll = parseExcludedIds(normalized);
            const blogIdsToAdd = [...new Set(parsedAll)].filter(Boolean);
            if (blogIdsToAdd.length === 0) { alert("ì•„ì´ë”” ë˜ëŠ” ê³„ì •ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            const windowKey = getTodayWindowKey(seoulNow());
            try {
                const st = document.getElementById("sharedExcludeStatus");
                if (st) st.textContent = `â³ ê³µìœ  ì œì™¸ ì¶”ê°€ì¤‘... (${blogIdsToAdd.length}ëª…)`;

                for (const blogId of blogIdsToAdd) {
                    await sharedExcludeUpsert(windowKey, null, blogId);
                }
                inp.value = "";
                await sharedExcludeRefresh();
                appendLog(`âœ… ì œì™¸ ìš”ì²­ ì¶”ê°€ ì™„ë£Œ: ${blogIdsToAdd.join(', ')} (ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ê³µìœ ë¨)`);
            } catch (e) {
                alert(`ê³µìœ  ì œì™¸ ì¶”ê°€ ì‹¤íŒ¨: ${e.message}`);
                appendLog(`âŒ ì œì™¸ ìš”ì²­ ì¶”ê°€ ì‹¤íŒ¨: ${e.message}`);
            }
        }

        async function sharedExcludeEdit(key) {
            const windowKey = getTodayWindowKey(seoulNow());
            const newVal = prompt("ìˆ˜ì •í•  ì•„ì´ë”” ë˜ëŠ” ê³„ì •ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (newVal === null) return;
            const parsed = parseExcludedIds(newVal);
            const blogId = parsed[0];
            if (!blogId) { alert("ì•„ì´ë”” ë˜ëŠ” ê³„ì •ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            try {
                await sharedExcludeUpsert(windowKey, key, blogId);
                await sharedExcludeRefresh();
            } catch (e) {
                alert(`ìˆ˜ì • ì‹¤íŒ¨: ${e.message}`);
            }
        }

        async function sharedExcludeRemove(key) {
            const ok = confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”? (ëª¨ë“  ì‚¬ìš©ìì—ê²Œì„œ ì¦‰ì‹œ ë°˜ì˜)");
            if (!ok) return;
            const windowKey = getTodayWindowKey(seoulNow());
            try {
                await sharedExcludeDelete(windowKey, key);
                await sharedExcludeRefresh();
            } catch (e) {
                alert(`ì‚­ì œ ì‹¤íŒ¨: ${e.message}`);
            }
        }

        async function sharedExcludeGetIdsForCurrentWindow() {
            if (!isSharedExcludeEnabled()) return [];
            const windowKey = getTodayWindowKey(seoulNow());
            const m = await sharedExcludeFetchMap(windowKey);
            return Object.values(m || {}).map(v => v?.blogId).filter(Boolean);
        }

        // ì£¼ê¸°ì ìœ¼ë¡œ ì œì™¸ ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨ (30ì´ˆë§ˆë‹¤)
        function startAutoRefreshExcludeList() {
            // ì´ˆê¸° ë¡œë“œ í›„ 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
            setInterval(async () => {
                if (!isRunning) { // ìˆ˜ì§‘ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ìƒˆë¡œê³ ì¹¨
                    await sharedExcludeRefresh();
                }
            }, 30000); // 30ì´ˆ
        }

        window.onload = async function () {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // Better formatting "12ì›”06ì¼"
            const m = (yesterday.getMonth() + 1).toString().padStart(2, '0');
            const d = yesterday.getDate().toString().padStart(2, '0');
            const yesterdayStr = `${m}ì›”${d}ì¼`;

            // document.getElementById('yesterdayLabel').textContent = yesterdayStr;
            document.getElementById('dateDisplay').textContent = today.toISOString().split('T')[0];

            await sharedMembersRefresh();
            setAdminMode(false);
            setMembersListExpanded(false);
            await sharedExcludeRefresh(); // await ì¶”ê°€í•˜ì—¬ í™•ì‹¤íˆ ë¡œë“œ
            sharedExcludeAutoPurgeIfDue();
            scheduleSharedExcludeDailyPurge();
            startAutoRefreshExcludeList(); // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
            appendLog(`âœ… ê¸°ë³¸ íšŒì› ëª©ë¡ ë¡œë“œ ì™„ë£Œ (ì´ ${blogIds.length}ëª…)`);
            appendLog(`âš ï¸ ${yesterdayStr} í’ˆì•—ì´ ë‚´ì—­ì„ ì…ë ¥í•˜ê³  'ìë£Œ ì ìš©'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
        };

        // Apply Button Logic
        function applyPrevData() {
            const content = document.getElementById('prevDataInput').value.trim();
            if (content.length < 5) {
                alert("ë‚´ìš©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš” (5ê¸€ì ì´ìƒ).");
                return;
            }

            isDataApplied = true;
            document.getElementById('prevDataStatus').textContent = "âœ… ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.";
            document.getElementById('prevDataStatus').style.color = "green";

            // Enable Start Button
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.style.backgroundColor = "#03c75a"; // Restore color

            alert("ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
            appendLog("âœ… ìë£Œê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì§‘ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }

        // Prev Data Input Listener (Reset on change)
        document.getElementById('prevDataInput').addEventListener('input', function (e) {
            if (isDataApplied) {
                isDataApplied = false;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').style.backgroundColor = "#ccc";
                document.getElementById('prevDataStatus').textContent = "* ë‚´ìš©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì ìš©í•´ì£¼ì„¸ìš”.";
                document.getElementById('prevDataStatus').style.color = "#ff4d4f";
            }
        });

        function appendLog(msg) {
            const log = document.getElementById('logArea');
            log.innerHTML += msg + "\n";
            log.scrollTop = log.scrollHeight;
        }

        function stopCollecting() {
            if (isRunning) {
                stopRequested = true;
                appendLog("âš ï¸ ì¤‘ì§€ ìš”ì²­ë¨... (í˜„ì¬ ì‘ì—… ì™„ë£Œ í›„ ì¤‘ì§€)");
            }
        }

        function toggleButtons(running) {
            document.getElementById('startBtn').disabled = running;
            document.getElementById('stopBtn').disabled = !running;
            document.getElementById('prevDataInput').disabled = running;
            document.getElementById('applyBtn').disabled = running;
        }

        async function startCollecting() {
            if (!isDataApplied) { alert("ë¨¼ì € 'ìë£Œ ì ìš©' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”."); return; }
            const _n = new Date();
            if (_n.getHours() < 20) { alert("í’ˆì•—ì´ ë§í¬ ìˆ˜ì§‘ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. ìˆ˜ì§‘ì‹œê°„ì€ ì €ë… 20:00ë¶„~ 23:59ë¶„ ê¹Œì§€ ì…ë‹ˆë‹¤."); return; }

            const _pData = document.getElementById('prevDataInput').value;
            // ë´‰ì‚¬ ê³„ì •(ìˆ˜ì§‘ ì œì™¸): ì „ì¼ ìë£Œì—ì„œ ì¶”ì¶œë˜ëŠ” ì œì™¸ ëª©ë¡
            const _serviceExcl = parseExcludedIds(_pData);

            // ê³µìœ  ì œì™¸ìš”ì²­(ìˆ˜ì§‘ ì œì™¸, ë´‰ì‚¬ ì•„ë‹˜)
            let _reqExcl = [];
            try {
                _reqExcl = await sharedExcludeGetIdsForCurrentWindow();
            } catch (e) {
                // Don't block collecting on shared storage failure
                appendLog(`âš ï¸ ê³µìœ  ì œì™¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨(ë¬´ì‹œí•˜ê³  ì§„í–‰): ${e.message}`);
            }

            // ìµœì¢… ìˆ˜ì§‘ ì œì™¸(ë´‰ì‚¬ + ì œì™¸ìš”ì²­)
            const _excl = [...new Set([..._serviceExcl, ..._reqExcl])];

            if (blogIds.length === 0) { alert("ë¸”ë¡œê·¸ ì•„ì´ë”” ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
            const _tIds = blogIds.filter(id => !_excl.includes(id));

            if (_tIds.length === 0) {
                alert(_excl.length > 0 ? "ëª¨ë“  ì•„ì´ë””ê°€ ë´‰ì‚¬ ê³„ì •(ì œì™¸)ìœ¼ë¡œ ë¶„ë¥˜ë˜ì–´ ìˆ˜ì§‘í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤." : "ìˆ˜ì§‘í•  ì•„ì´ë””ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            isRunning = true;
            stopRequested = false;
            toggleButtons(true);
            document.getElementById('logArea').innerHTML = "";
            appendLog(`ğŸš€ í¬ë¡¤ë§ ì‹œì‘...`);
            appendLog(`- ì „ì²´ ëŒ€ìƒ: ${blogIds.length}ëª…`);
            appendLog(`- ë´‰ì‚¬ ê³„ì •(ìˆ˜ì§‘ ì œì™¸): ${_serviceExcl.length}ëª…`);
            if (_serviceExcl.length > 0) appendLog(`  (${_serviceExcl.join(', ')})`);
            appendLog(`- ì œì™¸ìš”ì²­(ìˆ˜ì§‘ ì œì™¸): ${_reqExcl.length}ëª…`);
            if (_reqExcl.length > 0) appendLog(`  (${_reqExcl.join(', ')})`);
            appendLog(`- ê¸ˆì¼ ìˆ˜ì§‘ ëŒ€ìƒ: ${_tIds.length}ëª…`);

            const _cnt = 3;
            const _tDate = new Date(_n);
            const _sTime = new Date(_tDate); _sTime.setDate(_sTime.getDate() - 1); _sTime.setHours(20, 0, 0, 0);
            const _eTime = new Date(_tDate); _eTime.setHours(20, 0, 0, 0);

            appendLog(`ìˆ˜ì§‘ ê¸°ê°„: ${formatDate(_sTime)} ~ ${formatDate(_eTime)}`);

            let _cLinks = [];
            let _cIds = [];

            // Obfuscated Proxy & RSS Logic
            // _0x1 = proxies (first part), _0x2 = RSS base
            const _0x1 = [
                "aHR0cHM6Ly9jb3JzcHJveHkuaW8vPw==",
                "aHR0cHM6Ly9hcGkuYWxsb3JpZ2lucy53aW4vcmF3P3VybD0=",
                "aHR0cHM6Ly9hcGkuY29kZXRhYnMuY29tL3YxL3Byb3h5P3F1ZXN0PQ=="
            ];
            const _0x2 = "aHR0cHM6Ly9yc3MuYmxvZy5uYXZlci5jb20v"; // https://rss.blog.naver.com/

            for (let i = 0; i < _tIds.length; i++) {
                if (stopRequested) { appendLog("ğŸ›‘ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."); break; }
                const _bid = _tIds[i];
                appendLog(`[${i + 1}/${_tIds.length}] ${_bid} í™•ì¸ ì¤‘...`);

                let _ok = false;
                let _err = null;

                for (let k = 0; k < _0x1.length; k++) {
                    if (_ok) break;
                    try {
                        // Decode base + bid + .xml
                        const _rUrl = atob(_0x2) + _bid + ".xml";
                        // Decode proxy + encodeURIComponent(rssUrl)
                        const _fUrl = atob(_0x1[k]) + encodeURIComponent(_rUrl) + `&t=${new Date().getTime()}`;

                        const _ctrl = new AbortController();
                        const _tm = setTimeout(() => _ctrl.abort(), 5000);

                        const _res = await fetch(_fUrl, { signal: _ctrl.signal });
                        clearTimeout(_tm);

                        if (!_res.ok) throw new Error(`HTTP ${_res.status}`);

                        const _txt = await _res.text();
                        if (!_txt.includes("<rss") && !_txt.includes("<feed")) throw new Error("Invalid XML");

                        const _xml = new DOMParser().parseFromString(_txt, "text/xml");
                        const _items = _xml.getElementsByTagName("item");
                        let _vPosts = [];

                        for (let j = 0; j < _items.length; j++) {
                            const _it = _items[j];
                            const _pDt = _it.getElementsByTagName("pubDate")[0]?.textContent;
                            const _lt = _it.getElementsByTagName("link")[0]?.textContent;

                            if (_pDt && _lt) {
                                const _pd = new Date(_pDt);
                                if (_pd >= _sTime && _pd < _eTime) {
                                    let _ml = _lt.replace("://blog.naver.com/", "://m.blog.naver.com/");
                                    _vPosts.push({ d: _pd, u: _ml, i: _bid });
                                }
                            }
                        }

                        _vPosts.sort((a, b) => b.d - a.d);
                        const _fin = _vPosts.slice(0, _cnt);

                        if (_fin.length > 0) {
                            appendLog(`  - âœ… ${_fin.length}ê°œ í¬ìŠ¤íŒ… ë°œê²¬`);
                            _fin.forEach(p => _cLinks.push(p.u));
                            if (!_cIds.includes(_bid)) _cIds.push(_bid);
                        } else {
                            appendLog(`  - í•´ë‹¹ ê¸°ê°„ í¬ìŠ¤íŒ… ì—†ìŒ`);
                        }
                        _ok = true;

                    } catch (e) { _err = e.message; }
                }

                if (!_ok) appendLog(`  - âŒ ìˆ˜ì§‘ ì‹¤íŒ¨ (ëª¨ë“  í”„ë¡ì‹œ ì‹œë„ ì‹¤íŒ¨): ${_err}`);
                await new Promise(r => setTimeout(r, 1000));
            }

            if (_cLinks.length > 0) {
                downloadFiles(_cLinks, _cIds, _serviceExcl, _reqExcl);
            } else {
                if (!stopRequested) alert("ìˆ˜ì§‘ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. (ê¸°ê°„ ë‚´ í¬ìŠ¤íŒ… ì—†ìŒ)");
            }

            isRunning = false;
            toggleButtons(false);
            appendLog("âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ");
        }

        // Parse extracted IDs (or member numbers) from the pasted text
        function parseExcludedIds(text) {
            const lines = text.split('\n');
            const ids = [];
            for (let line of lines) {
                const raw = (line || "").trim();
                if (!raw) continue;

                // "ìˆ«ì. " í˜•ì‹ ì²˜ë¦¬ (ì˜ˆ: "1. ", "18. ")
                // ìˆ«ìì™€ ì ì„ ì œê±°í•œ í›„ ì‹¤ì œ ì•„ì´ë””ê°€ ìˆëŠ”ì§€ í™•ì¸
                let cleaned = raw.replace(/^\d+\.\s*/, '').trim();
                
                // "ìˆ«ì. " í˜•ì‹ì¸ë° ì•„ì´ë””ê°€ ì—†ëŠ” ê²½ìš° (ì˜ˆ: "1. ", "18. ") â†’ ë¬´ì‹œ
                if (cleaned === "" && /^\d+\.\s*$/.test(raw)) {
                    continue; // ë¹ˆ í•­ëª© ë¬´ì‹œ
                }

                // ì‹¤ì œ ì•„ì´ë””ê°€ ìˆëŠ” ê²½ìš°
                if (cleaned && /^[a-zA-Z0-9_-]+$/.test(cleaned)) {
                    ids.push(cleaned);
                    continue;
                }

                // ìˆœìˆ˜ ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° (ì˜ˆ: "18")
                // ì´ëŠ” ì˜ë„ëœ íšŒì› ë²ˆí˜¸ì¼ ìˆ˜ë„ ìˆì§€ë§Œ, ë¹ˆ í•­ëª© ëª©ë¡ì˜ ë²ˆí˜¸ì¼ ìˆ˜ë„ ìˆìŒ
                // ë” ì•ˆì „í•˜ê²Œ ì²˜ë¦¬: "ìˆ«ì. " í˜•ì‹ì´ ì•„ë‹ˆê³  ìˆœìˆ˜ ìˆ«ìë§Œ ìˆìœ¼ë©´ ë¬´ì‹œ
                // (ì‹¤ì œë¡œ íšŒì› ë²ˆí˜¸ë¡œ ì…ë ¥í•˜ë ¤ë©´ "18. ì•„ì´ë””" í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•¨)
                if (/^\d+$/.test(raw)) {
                    // ìˆœìˆ˜ ìˆ«ìë§Œ ìˆëŠ” ê²½ìš°ëŠ” ë¬´ì‹œ (ë¹ˆ í•­ëª© ëª©ë¡ì˜ ë²ˆí˜¸ë¡œ ê°„ì£¼)
                    continue;
                }
            }
            return ids;
        }

        function formatDate(d) {
            return d.toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        // ëª¨ë°”ì¼ ê¸°ê¸° ê°ì§€
        function isMobileDevice() {
            return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        }

        // iOS ê°ì§€
        function isIOS() {
            return /iPhone|iPad|iPod/i.test(navigator.userAgent);
        }

        function downloadFiles(links, collectedIds, serviceExcludedIds, requestExcludedIds) {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = (now.getMonth() + 1).toString().padStart(2, '0');
            const dd = now.getDate().toString().padStart(2, '0');
            const dateStr = `${yyyy}${mm}${dd}`;
            const linkFileName = `í’ˆì•—ì´ë§í¬ ${yyyy}ë…„${mm}ì›”${dd}ì¼.txt`;

            // 1. Link File
            const linkContent = links.join("\n");
            
            // 2. ID File (New Format)
            // ë§ˆìŠ¤í„° ì•„ì´ë””ëŠ” ì°¸ì—¬ì•„ì´ë”” íŒŒì¼ì—ì„œ ì œì™¸ (ë§í¬ ìˆ˜ì§‘ì€ í•˜ì§€ë§Œ ì°¸ì—¬ì•„ì´ë””ì—ëŠ” í‘œì‹œ ì•ˆ í•¨)
            const participantIds = collectedIds.filter(id => !MASTER_IDS.includes(id));
            const formattedDate = `${yyyy}ë…„ ${mm}ì›” ${dd}ì¼`;
            const totalCount = participantIds.length;

            let idContent = `${formattedDate} ì°¸ì—¬ì•„ì´ë””\n`;
            idContent += `ì´ ì°¸ì—¬ ì•„ì´ë”” : ${totalCount}ê°œ\n`;
            idContent += `ë´‰ì‚¬ ì•„ì´ë”” : ${serviceExcludedIds.length}ê°œ\n`;
            idContent += `ê¸ˆì¼ ì œì™¸ìš”ì²­ : ${requestExcludedIds.length}ê°œ\n\n`;

            idContent += `ê¸ˆì¼ ë´‰ì‚¬ ê³„ì •\n`;
            if (serviceExcludedIds.length > 0) {
                serviceExcludedIds.forEach((id, idx) => {
                    idContent += `${idx + 1}. ${id}\n`;
                });
            } else {
                idContent += `(ì—†ìŒ)\n`;
            }
            idContent += `\n`;

            idContent += `ê¸ˆì¼ ì œì™¸ìš”ì²­ (ë´‰ì‚¬ ì•„ë‹˜ / ìˆ˜ì§‘ ì œì™¸)\n`;
            if (requestExcludedIds.length > 0) {
                requestExcludedIds.forEach((id, idx) => {
                    idContent += `${idx + 1}. ${id}\n`;
                });
            } else {
                idContent += `(ì—†ìŒ)\n`;
            }
            idContent += `\n`;

            idContent += `ê¸ˆì¼ í’ˆì•—ì´ ê³„ì •\n`;
            participantIds.forEach((id, idx) => {
                idContent += `${idx + 1}. ${id}\n`;
            });

            // ëª¨ë°”ì¼ì—ì„œëŠ” ìˆœì°¨ì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ (iOS í˜¸í™˜ì„±)
            if (isMobileDevice()) {
                appendLog(`ğŸ“± ëª¨ë°”ì¼ ê¸°ê¸° ê°ì§€ - íŒŒì¼ ì €ì¥ ì¤‘...`);
                // ì²« ë²ˆì§¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                downloadTextFileMobile(linkContent, linkFileName, () => {
                    appendLog(`ğŸ’¾ ë§í¬ íŒŒì¼ ì €ì¥ ì™„ë£Œ (ì´ ${links.length}ê°œ)`);
                    // ì•½ê°„ì˜ ì§€ì—° í›„ ë‘ ë²ˆì§¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    setTimeout(() => {
                        downloadTextFileMobile(idContent, `${dateStr}ì°¸ì—¬ì•„ì´ë””.txt`, () => {
                            appendLog(`ğŸ’¾ ì°¸ì—¬ì•„ì´ë”” íŒŒì¼ ì €ì¥ ì™„ë£Œ`);
                            appendLog(`âœ… ëª¨ë“  íŒŒì¼ ì €ì¥ ì™„ë£Œ!`);
                        });
                    }, 500);
                });
            } else {
                // ë°ìŠ¤í¬í†±ì—ì„œëŠ” ê¸°ì¡´ ë°©ì‹
                downloadTextFile(linkContent, linkFileName);
                appendLog(`ğŸ’¾ ë§í¬ íŒŒì¼ ì €ì¥ ì™„ë£Œ (ì´ ${links.length}ê°œ)`);
                
                setTimeout(() => {
                    downloadTextFile(idContent, `${dateStr}ì°¸ì—¬ì•„ì´ë””.txt`);
                    appendLog(`ğŸ’¾ ì°¸ì—¬ì•„ì´ë”” íŒŒì¼ ì €ì¥ ì™„ë£Œ`);
                }, 300);
            }
        }

        function downloadTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ëª¨ë°”ì¼ìš© ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (iOS í˜¸í™˜)
        function downloadTextFileMobile(content, filename, callback) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            if (isIOS()) {
                // iOSì˜ ê²½ìš°: ìƒˆ ì°½ì—ì„œ ì—´ì–´ì„œ ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì €ì¥
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    appendLog(`ğŸ“± iOS: "${filename}" íŒŒì¼ì´ ìƒˆ ì°½ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤. ê³µìœ  ë²„íŠ¼ì„ ëˆŒëŸ¬ íŒŒì¼ì„ ì €ì¥í•˜ì„¸ìš”.`);
                    // ìƒˆ ì°½ì´ ì—´ë¦° í›„ ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  URL í•´ì œ
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                        if (callback) callback();
                    }, 1000);
                } else {
                    // íŒì—…ì´ ì°¨ë‹¨ëœ ê²½ìš°: ì§ì ‘ ë‹¤ìš´ë¡œë“œ ì‹œë„
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        if (callback) callback();
                    }, 100);
                }
            } else {
                // Android ë“± ë‹¤ë¥¸ ëª¨ë°”ì¼: ì¼ë°˜ ë‹¤ìš´ë¡œë“œ ì‹œë„
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    if (callback) callback();
                }, 100);
            }
        }
    </script>
</body>

</html>
