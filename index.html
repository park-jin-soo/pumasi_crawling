<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„ìš°ë¯¸ ì†Œí†µë°© í’ˆì•—ì´ ë§í¬ ìˆ˜ì§‘ê¸° (HTML ë²„ì „)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #03c75a;
            --bg-color: #f5f6f7;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 24px;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        #membersAdminSection {
            border: 2px solid #ff3b30;
        }

        .section-title {
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn.stop {
            background-color: #ff4d4f;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .log-area {
            width: 100%;
            height: 300px;
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 6px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }

        .info-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .member-list {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            background: #fafafa;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 180px;
            overflow-y: auto;
        }

        .shared-exclude-toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .shared-exclude-input {
            flex: 1;
            min-width: 220px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 13px;
        }

        .shared-exclude-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 8px;
        }

        .shared-exclude-table th,
        .shared-exclude-table td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: left;
        }

        .shared-exclude-table th {
            background: #fafafa;
            color: #666;
        }

        .collapsible {
            display: none;
        }

        .shared-members-toggle-row {
            display: flex;
            justify-content: flex-end;
            margin-top: 6px;
        }

        .shared-exclude-actions {
            display: flex;
            gap: 6px;
        }

        .shared-members-status {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }

        .btn.small {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
        }

        .btn.gray {
            background-color: #666;
        }

        .btn.outline {
            background: #fff;
            border: 1px solid #ccc;
            color: #333;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ì†Œí†µë°© í’ˆì•—ì´ ë§í¬ ìˆ˜ì§‘ê¸° V12.19</h1>

        <div class="section">
            <span class="section-title">ì†Œí†µë°© í’ˆì•—ì´ ê³„ì • ì•„ì´ë”” ëª©ë¡</span>
            <div id="memberList" class="member-list"></div>
        </div>

        <div class="section" id="membersAdminSection">
            <span class="section-title">íšŒì› ì•„ì´ë”” ê´€ë¦¬ (ë°©ì¥ ê´€ë¦¬ììš©)</span>
            <div class="info-text" style="margin-bottom: 8px;">
                * ì…ë ¥: ì•„ì´ë”” ì—¬ëŸ¬ ê°œ ê°€ëŠ¥ (ì½¤ë§ˆ/ì¤„ë°”ê¿ˆ) ì˜ˆ) <strong>dbfkd9, wjddla402</strong>
            </div>

            <div class="shared-exclude-toolbar">
                <button id="adminLoginBtn" class="btn small gray" onclick="adminLogin()">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
                <button id="adminLogoutBtn" class="btn small outline" onclick="adminLogout()" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
                <input id="sharedMembersAddInput" class="shared-exclude-input"
                    placeholder="ì¶”ê°€í•  ì•„ì´ë”” ì…ë ¥" />
                <button id="sharedMembersAddBtn" class="btn small" onclick="sharedMembersAdd()" disabled>ì¶”ê°€</button>
                <button class="btn small outline" onclick="sharedMembersRefresh()">ìƒˆë¡œê³ ì¹¨</button>
                <button id="sharedMembersSeedBtn" class="btn small gray" onclick="sharedMembersSeedFromHardcoded()" disabled>ì´ˆê¸°ëª©ë¡ ì—…ë¡œë“œ</button>
            </div>
            <div id="sharedMembersStatus" class="shared-members-status">* íšŒì›ëª©ë¡ ë¡œë“œ ì¤‘...</div>

            <div class="shared-members-toggle-row">
                <button id="sharedMembersToggleBtn" class="btn small outline" onclick="toggleSharedMembersList()">íšŒì›ëª©ë¡ í¼ì¹˜ê¸°</button>
            </div>

            <div id="sharedMembersCollapsible" class="collapsible">
                <table class="shared-exclude-table">
                    <thead>
                        <tr>
                            <th style="width: 55%;">ì•„ì´ë””</th>
                            <th style="width: 25%;">ë“±ë¡ì‹œê°(ì„œìš¸)</th>
                            <th style="width: 20%;">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="sharedMembersTbody">
                        <tr><td colspan="3" style="color:#888;">(ì—°ë™ í›„ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤)</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <span class="section-title">í’ˆì•—ì´ ì œì™¸ ìš”ì²­ (ìë™ ì ìš©)</span>
            <div class="shared-exclude-toolbar">
                <input id="sharedExcludeAddInput" class="shared-exclude-input"
                    placeholder="ì œì™¸í•  ì•„ì´ë”” ë˜ëŠ” ë²ˆí˜¸ ì…ë ¥" />
                <button id="sharedExcludeAddBtn" class="btn small" onclick="sharedExcludeAdd()">ì¶”ê°€</button>
                <button id="sharedExcludeRefreshBtn" class="btn small outline" onclick="sharedExcludeRefresh()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="info-text" id="sharedExcludeStatus">* ì•„ì§ ì €ì¥ì†Œê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>

            <table class="shared-exclude-table">
                <thead>
                    <tr>
                        <th style="width: 55%;">ì•„ì´ë””</th>
                        <th style="width: 25%;">ë“±ë¡ì‹œê°(ì„œìš¸)</th>
                        <th style="width: 20%;">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="sharedExcludeTbody">
                    <tr><td colspan="3" style="color:#888;">(ì—°ë™ í›„ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤)</td></tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <span class="section-title">1. ì „ì¼ í’ˆì•—ì´ ìë£Œ í™•ì¸</span>
            <textarea id="prevDataInput" rows="5" placeholder="ì–´ì œ ì™„ë£Œ ë‚´ì—­ ë¶™ì—¬ë„£ê¸°..."
                style="width: 100%; padding: 10px; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;"></textarea>
            <div class="row" style="margin-top: 10px; justify-content: flex-end;">
                <button id="applyBtn" class="btn" onclick="applyPrevData()" style="background-color: #666;">ìë£Œ ì ìš©</button>
            </div>
            <div class="info-text" id="prevDataStatus" style="color: #ff4d4f;">* 'ìë£Œ ì ìš©' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>

        <div class="section">
            <span class="section-title">2. ìˆ˜ì§‘ ì„¤ì •</span>
            <div class="row">ğŸ“… ìˆ˜ì§‘ ê¸°ì¤€: <strong id="dateDisplay"></strong></div>
            <div class="row">ìˆ˜ì§‘ ê°œìˆ˜: <strong>3ê°œ</strong> (ê³ ì •)</div>
        </div>

        <div class="row" style="justify-content: center; margin-bottom: 20px;">
            <button id="startBtn" class="btn" onclick="startCollecting()" disabled style="background-color: #ccc;">ğŸš€ ìˆ˜ì§‘ ì‹œì‘</button>
            <button id="stopBtn" class="btn stop" onclick="stopCollecting()" disabled>â¹ï¸ ì¤‘ì§€</button>
        </div>

        <div class="section-title">ë¡œê·¸</div>
        <div id="logArea" class="log-area"></div>
    </div>

    <script>
        let isRunning = false;
        let stopRequested = false;
        let blogIds = [];
        let isDataApplied = false;

        // ë°©ì¥ ê³„ì • ì„¤ì • (ë³´ê³ ì„œ í•„í„°ë§ìš©)
        const ADMIN_ACCOUNT_ID = 'brain_1018';

        const HARDCODED_IDS_ENCODED = [
            "bWVlbmE3Nw==", "bWVlbmExMjI1", "d2pkdGpkZG4wOTE=", "cmVhbG9vX3U=", "dWVvNzc=",
            "aGFlbWlsNDAy", "YXJpYXJpNzQ4Ng==", "Ymx1ZXBhbnRzMjc=", "NTIxb2h3NTIx",
            "cmVkcGFudHMyNw==", "aG9uZ2hvbmd3YW5uYQ==", "dmlzaW9uLWJlc3Q=", "Z2JoeTEwMA==",
            "d2hpdGU4MDU4", "c3R1ZHk4MDU4", "Y2xsYXJh", "cGhnNDQ2Ng==", "c2Vuc2VxdWVlbg==",
            "Z29kX2JsZXNzeW91NTU2NQ==", "aHNlNzI5", "aGktc29yYQ==", "bGlmZS1uZXh1czc5", "eXVsZF9kdW5n",
            "aGFwcHktc3BhY2Utc2FlbXRlcg==", "c3V5b3VuMTAyMw==", "ZGJma2Q5Mw==", "d2pkZGxhNDAy", "eW9vbnlfbW9tbXk=",
            "d29uczBfMA==", "bWN0aGF0MTMxMzEz", "c2luZ2NjbQ==", "bWFrZWNjbQ==", "dGhvbWFzLTgyNzI=",
            "cmlha29p", "YXRvbTA5MTIt", "ZmlsbG5nbw==", "YWh5b3VuZzEwMw==", "amluaS1yYW5n", "YnJhaW5fMTAxOA=="
        ];

        const HARDCODED_IDS = [...new Set(HARDCODED_IDS_ENCODED.map(id => atob(id)))];
        blogIds = [...HARDCODED_IDS];

        const SHARED_EXCLUDE_DB_URL = "https://pumasi-exclude-default-rtdb.firebaseio.com";

        function isSharedExcludeEnabled() {
            return typeof SHARED_EXCLUDE_DB_URL === "string" && SHARED_EXCLUDE_DB_URL.trim().startsWith("https://");
        }

        let isAdmin = false;
        const ADMIN_PIN_ENC = "NzcwMg==";

        function adminPinMatches(pin) { try { return String(pin || "") === atob(ADMIN_PIN_ENC); } catch { return false; } }

        function setAdminMode(on) {
            isAdmin = !!on;
            document.getElementById("adminLoginBtn").style.display = isAdmin ? "none" : "inline-block";
            document.getElementById("adminLogoutBtn").style.display = isAdmin ? "inline-block" : "none";
            document.getElementById("sharedMembersAddInput").disabled = !isAdmin;
            document.getElementById("sharedMembersAddBtn").disabled = !isAdmin;
            document.getElementById("sharedMembersSeedBtn").disabled = !isAdmin;
            const st = document.getElementById("sharedMembersStatus");
            if (st && !st.textContent.includes("íšŒì›ëª©ë¡")) {
                st.textContent = isAdmin ? "âœ… ê´€ë¦¬ì ê¶Œí•œ í™œì„±í™”ë¨" : "ğŸ”’ ê´€ë¦¬ì ë¡œê·¸ì¸ í•„ìš”";
            }
        }

        function adminLogin() {
            const pin = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (pin === null) return;
            if (!adminPinMatches(pin.trim())) { alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
            setAdminMode(true);
        }

        function adminLogout() { setAdminMode(false); }

        function toggleSharedMembersList() {
            const wrap = document.getElementById("sharedMembersCollapsible");
            const btn = document.getElementById("sharedMembersToggleBtn");
            const isExp = wrap.style.display === "block";
            wrap.style.display = isExp ? "none" : "block";
            btn.textContent = isExp ? "íšŒì›ëª©ë¡ í¼ì¹˜ê¸°" : "íšŒì›ëª©ë¡ ì ‘ê¸°";
        }

        function seoulNow() { return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" })); }

        function getTodayWindowKey(nowSeoul = seoulNow()) {
            const start = new Date(nowSeoul);
            start.setHours(20, 0, 0, 0);
            if (nowSeoul < start) start.setDate(start.getDate() - 1);
            return `${start.getFullYear()}${String(start.getMonth() + 1).padStart(2, "0")}${String(start.getDate()).padStart(2, "0")}`;
        }

        function formatSeoul(ts) {
            try { return new Date(ts).toLocaleString("ko-KR", { timeZone: "Asia/Seoul", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" }); } catch { return ""; }
        }

        function renderMemberList() {
            const el = document.getElementById('memberList');
            if (el) el.textContent = blogIds.map((id, idx) => `${idx + 1}. ${id}`).join("\n");
        }

        async function sharedMembersFetchMap() {
            if (!isSharedExcludeEnabled()) return {};
            const res = await fetch(`${SHARED_EXCLUDE_DB_URL}/members.json`, { cache: "no-store" });
            return (await res.json()) || {};
        }

        async function sharedMembersUpsert(keyOrNull, blogId) {
            const payload = { blogId, updatedAt: Date.now() };
            if (!keyOrNull) payload.createdAt = Date.now();
            const url = keyOrNull ? `${SHARED_EXCLUDE_DB_URL}/members/${keyOrNull}.json` : `${SHARED_EXCLUDE_DB_URL}/members.json`;
            const method = keyOrNull ? "PATCH" : "POST";
            await fetch(url, { method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        }

        async function sharedMembersDelete(key) {
            await fetch(`${SHARED_EXCLUDE_DB_URL}/members/${key}.json`, { method: "DELETE" });
        }

        function sharedMembersRenderRows(items) {
            const tbody = document.getElementById("sharedMembersTbody");
            if (!tbody) return;
            if (!items || items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="color:#888;">(íšŒì›ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤)</td></tr>`;
                return;
            }
            tbody.innerHTML = items.map(it => `
                <tr>
                    <td><strong>${it.blogId}</strong></td>
                    <td style="color:#666;">${formatSeoul(it.createdAt || it.updatedAt)}</td>
                    <td>
                        <div class="shared-exclude-actions">
                            <button class="btn small outline" onclick="sharedMembersEdit('${it.key}')" ${isAdmin ? "" : "disabled"}>ìˆ˜ì •</button>
                            <button class="btn small stop" onclick="sharedMembersRemove('${it.key}')" ${isAdmin ? "" : "disabled"}>ì‚­ì œ</button>
                        </div>
                    </td>
                </tr>
            `).join("");
        }

        async function sharedMembersRefresh() {
            const st = document.getElementById("sharedMembersStatus");
            try {
                const m = await sharedMembersFetchMap();
                const items = Object.entries(m).map(([key, v]) => ({ key, ...v })).filter(x => x.blogId).sort((a, b) => a.blogId.localeCompare(b.blogId));
                sharedMembersRenderRows(items);
                blogIds = items.length > 0 ? [...new Set(items.map(x => x.blogId))] : [...HARDCODED_IDS];
                renderMemberList();
                if (st) st.textContent = `âœ… íšŒì›ëª©ë¡ ì ìš©: ${blogIds.length}ëª…`;
            } catch (e) { if (st) st.textContent = `âŒ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`; }
        }

        async function sharedMembersAdd() {
            const inp = document.getElementById("sharedMembersAddInput");
            const ids = inp.value.replaceAll(",", "\n").split("\n").map(s => s.trim()).filter(Boolean);
            if (ids.length === 0) return;
            for (const id of ids) await sharedMembersUpsert(null, id);
            inp.value = ""; await sharedMembersRefresh();
        }

        async function sharedMembersEdit(key) {
            const id = prompt("ìˆ˜ì •í•  ì•„ì´ë”” ì…ë ¥:");
            if (id) { await sharedMembersUpsert(key, id.trim()); await sharedMembersRefresh(); }
        }

        async function sharedMembersRemove(key) {
            if (confirm("ì‚­ì œí• ê¹Œìš”?")) { await sharedMembersDelete(key); await sharedMembersRefresh(); }
        }

        async function sharedMembersSeedFromHardcoded() {
            if (confirm("ì´ˆê¸° ëª©ë¡ì„ ì—…ë¡œë“œí• ê¹Œìš”?")) {
                for (const id of HARDCODED_IDS) await sharedMembersUpsert(null, id);
                await sharedMembersRefresh();
            }
        }

        async function sharedExcludeFetchMap(windowKey) {
            if (!isSharedExcludeEnabled()) return {};
            const res = await fetch(`${SHARED_EXCLUDE_DB_URL}/excludes/${windowKey}.json`, { cache: "no-store" });
            return (await res.json()) || {};
        }

        async function sharedExcludeUpsert(windowKey, keyOrNull, blogId) {
            const payload = { blogId, updatedAt: Date.now() };
            if (!keyOrNull) payload.createdAt = Date.now();
            const url = keyOrNull ? `${SHARED_EXCLUDE_DB_URL}/excludes/${windowKey}/${keyOrNull}.json` : `${SHARED_EXCLUDE_DB_URL}/excludes/${windowKey}.json`;
            const method = keyOrNull ? "PATCH" : "POST";
            await fetch(url, { method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        }

        async function sharedExcludeDelete(windowKey, key) {
            await fetch(`${SHARED_EXCLUDE_DB_URL}/excludes/${windowKey}/${key}.json`, { method: "DELETE" });
        }

        function sharedExcludeRenderRows(items) {
            const tbody = document.getElementById("sharedExcludeTbody");
            if (!tbody) return;
            if (!items || items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="color:#888;">(ê¸ˆì¼ ì œì™¸ ìš”ì²­ ì—†ìŒ)</td></tr>`;
                return;
            }
            tbody.innerHTML = items.map(it => `
                <tr>
                    <td><strong>${it.blogId}</strong></td>
                    <td style="color:#666;">${formatSeoul(it.createdAt || it.updatedAt)}</td>
                    <td>
                        <div class="shared-exclude-actions">
                            <button class="btn small outline" onclick="sharedExcludeEdit('${it.key}')">ìˆ˜ì •</button>
                            <button class="btn small stop" onclick="sharedExcludeRemove('${it.key}')">ì‚­ì œ</button>
                        </div>
                    </td>
                </tr>
            `).join("");
        }

        async function sharedExcludeRefresh() {
            const windowKey = getTodayWindowKey();
            const st = document.getElementById("sharedExcludeStatus");
            try {
                const m = await sharedExcludeFetchMap(windowKey);
                const items = Object.entries(m).map(([key, v]) => ({ key, ...v })).filter(x => x.blogId).sort((a, b) => b.updatedAt - a.updatedAt);
                sharedExcludeRenderRows(items);
                if (st) st.textContent = `âœ… ì œì™¸ ëª©ë¡ ì™„ë£Œ: ${items.length}ëª…`;
            } catch (e) { if (st) st.textContent = `âŒ ì‹¤íŒ¨: ${e.message}`; }
        }

        async function sharedExcludeAdd() {
            const inp = document.getElementById("sharedExcludeAddInput");
            const ids = parseExcludedIds(inp.value.replaceAll(",", "\n"));
            if (ids.length === 0) return;
            const wk = getTodayWindowKey();
            for (const id of ids) await sharedExcludeUpsert(wk, null, id);
            inp.value = ""; await sharedExcludeRefresh();
        }

        async function sharedExcludeEdit(key) {
            const id = prompt("ìˆ˜ì •í•  ì•„ì´ë””/ë²ˆí˜¸ ì…ë ¥:");
            if (id) { await sharedExcludeUpsert(getTodayWindowKey(), key, parseExcludedIds(id)[0]); await sharedExcludeRefresh(); }
        }

        async function sharedExcludeRemove(key) {
            if (confirm("ì‚­ì œí• ê¹Œìš”?")) { await sharedExcludeDelete(getTodayWindowKey(), key); await sharedExcludeRefresh(); }
        }

        window.onload = async function () {
            document.getElementById('dateDisplay').textContent = new Date().toISOString().split('T')[0];
            await sharedMembersRefresh();
            setAdminMode(false);
            sharedExcludeRefresh();
            appendLog(`âœ… ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ`);
        };

        function applyPrevData() {
            if (document.getElementById('prevDataInput').value.trim().length < 5) return;
            isDataApplied = true;
            const s = document.getElementById('prevDataStatus');
            s.textContent = "âœ… ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤."; s.style.color = "green";
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').style.backgroundColor = "#03c75a";
            appendLog("âœ… ì „ì¼ ìë£Œ ì ìš© ì™„ë£Œ");
        }

        function appendLog(msg) {
            const log = document.getElementById('logArea');
            log.innerHTML += msg + "\n"; log.scrollTop = log.scrollHeight;
        }

        function stopCollecting() { stopRequested = true; appendLog("âš ï¸ ì¤‘ì§€ ìš”ì²­ë¨..."); }

        async function startCollecting() {
            if (!isDataApplied) return;
            const now = new Date();
            if (now.getHours() < 20) { alert("ìˆ˜ì§‘ ì‹œê°„(20:00~23:59)ì´ ì•„ë‹™ë‹ˆë‹¤."); return; }

            const serviceExcl = parseExcludedIds(document.getElementById('prevDataInput').value);
            let reqExcl = [];
            try {
                const m = await sharedExcludeFetchMap(getTodayWindowKey());
                reqExcl = Object.values(m).map(v => v.blogId).filter(Boolean);
            } catch (e) { appendLog(`âš ï¸ ì œì™¸ëª©ë¡ ë¡œë“œì‹¤íŒ¨ ë¬´ì‹œ`); }

            const totalExcl = [...new Set([...serviceExcl, ...reqExcl])];
            const targetIds = blogIds.filter(id => !totalExcl.includes(id));

            if (targetIds.length === 0) { alert("ìˆ˜ì§‘í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤."); return; }

            isRunning = true; stopRequested = false;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('logArea').innerHTML = "";
            
            appendLog(`ğŸš€ ìˆ˜ì§‘ ì‹œì‘ (ëŒ€ìƒ: ${targetIds.length}ëª…)`);

            const startTime = new Date(now); startTime.setDate(startTime.getDate() - 1); startTime.setHours(20, 0, 0, 0);
            const endTime = new Date(now); endTime.setHours(20, 0, 0, 0);

            let collectedLinks = [];
            let collectedIds = [];

            const proxy = ["aHR0cHM6Ly9jb3JzcHJveHkuaW8vPw==", "aHR0cHM6Ly9hcGkuYWxsb3JpZ2lucy53aW4vcmF3P3VybD0="];

            for (let i = 0; i < targetIds.length; i++) {
                if (stopRequested) break;
                const bid = targetIds[i];
                appendLog(`[${i + 1}/${targetIds.length}] ${bid} í™•ì¸ ì¤‘...`);

                let ok = false;
                for (let k = 0; k < proxy.length; k++) {
                    if (ok) break;
                    try {
                        const url = atob(proxy[k]) + encodeURIComponent("https://rss.blog.naver.com/" + bid + ".xml") + `&t=${Date.now()}`;
                        const res = await fetch(url);
                        const txt = await res.text();
                        const xml = new DOMParser().parseFromString(txt, "text/xml");
                        const items = xml.getElementsByTagName("item");
                        let posts = [];
                        for (let j = 0; j < items.length; j++) {
                            const dt = new Date(items[j].getElementsByTagName("pubDate")[0]?.textContent);
                            const ln = items[j].getElementsByTagName("link")[0]?.textContent;
                            if (dt >= startTime && dt < endTime && ln) {
                                posts.push({ d: dt, u: ln.replace("://blog.naver.com/", "://m.blog.naver.com/") });
                            }
                        }
                        posts.sort((a, b) => b.d - a.d).slice(0, 3).forEach(p => collectedLinks.push(p.u));
                        if (posts.length > 0) collectedIds.push(bid);
                        ok = true;
                    } catch (e) {}
                }
                await new Promise(r => setTimeout(r, 800));
            }

            if (collectedLinks.length > 0) downloadFiles(collectedLinks, collectedIds, serviceExcl, reqExcl);
            isRunning = false; document.getElementById('startBtn').disabled = false; document.getElementById('stopBtn').disabled = true;
            appendLog("âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ");
        }

        function parseExcludedIds(text) {
            return text.split('\n').map(line => {
                const raw = line.trim();
                if (/^\d+$/.test(raw)) return blogIds[parseInt(raw, 10) - 1];
                const cleaned = raw.replace(/^\d+\.\s*/, '').trim();
                return /^[a-zA-Z0-9_-]+$/.test(cleaned) ? cleaned : null;
            }).filter(Boolean);
        }

        function downloadFiles(links, collectedIds, serviceExcludedIds, requestExcludedIds) {
            const now = seoulNow();
            const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;

            // 1. ë§í¬ íŒŒì¼ (ë°©ì¥ ê³„ì • ë§í¬ í¬í•¨)
            downloadTextFile(links.join("\n"), `ë§í¬ìˆ˜ì§‘${dateStr}.txt`);

            // 2. ì°¸ì—¬ì•„ì´ë”” ë³´ê³ ì„œ (ë°©ì¥ ê³„ì • brain_1018 í•„í„°ë§)
            const reportIds = collectedIds.filter(id => id !== ADMIN_ACCOUNT_ID);
            const totalCount = reportIds.length;
            
            let idContent = `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›” ${now.getDate()}ì¼ ì°¸ì—¬ì•„ì´ë””\n`;
            idContent += `ì´ ì°¸ì—¬ ì•„ì´ë”” : ${totalCount}ê°œ\n`;
            idContent += `ë´‰ì‚¬ ì•„ì´ë”” : ${serviceExcludedIds.length}ê°œ\n`;
            idContent += `ê¸ˆì¼ ì œì™¸ìš”ì²­ : ${requestExcludedIds.length}ê°œ\n\n`;

            idContent += `ê¸ˆì¼ ë´‰ì‚¬ ê³„ì •\n`;
            if (serviceExcludedIds.length > 0) serviceExcludedIds.forEach((id, idx) => { idContent += `${idx + 1}. ${id}\n`; });
            else idContent += `(ì—†ìŒ)\n`;
            idContent += `\n`;

            idContent += `ê¸ˆì¼ ì œì™¸ìš”ì²­\n`;
            idContent += `(ë´‰ì‚¬ ì•„ë‹˜ / ìˆ˜ì§‘ ì œì™¸)\n`;
            idContent += `----------------------\n`;
            if (requestExcludedIds.length > 0) requestExcludedIds.forEach((id, idx) => { idContent += `${idx + 1}. ${id}\n`; });
            else idContent += `(ì—†ìŒ)\n`;
            idContent += `\n`;

            idContent += `ê¸ˆì¼ í’ˆì•—ì´ ê³„ì •\n`;
            reportIds.forEach((id, idx) => { idContent += `${idx + 1}. ${id}\n`; });

            downloadTextFile(idContent, `${dateStr}ì°¸ì—¬ì•„ì´ë””.txt`);
            appendLog(`ğŸ’¾ íŒŒì¼ ì €ì¥ ì™„ë£Œ (ë°©ì¥ ê³„ì • ì œì™¸ ${totalCount}ëª…)`);
        }

        function downloadTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>
