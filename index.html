<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„ìš°ë¯¸ ì†Œí†µë°© í’ˆì•—ì´ ë§í¬ ìˆ˜ì§‘ê¸° (HTML ë²„ì „)</title>
    <!-- SheetJS for Excel reading -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #03c75a;
            --bg-color: #f5f6f7;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 24px;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .section-title {
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="file"] {
            font-size: 14px;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn.stop {
            background-color: #ff4d4f;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .log-area {
            width: 100%;
            height: 300px;
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 6px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }

        .info-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ì±„ìš°ë¯¸ ì†Œí†µë°© í’ˆì•—ì´ ë§í¬ ìˆ˜ì§‘ê¸°</h1>

        <!-- Previous Day Data Input -->
        <div class="section">
            <span class="section-title">1. ì „ì¼ í’ˆì•—ì´ ìë£Œ í™•ì¸</span>
            <div class="info-text" style="margin-bottom: 5px;">
                ì†Œí†µë°©ì˜ ë§ˆì§€ë§‰ í’ˆì•—ì´ì™„ë£Œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•˜ì—¬ ì•„ë˜ ì°½ì— ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”
            </div>
            <textarea id="prevDataInput" rows="5" placeholder="ì—¬ê¸°ì— ì–´ì œ ì™„ë£Œí•œ ë‚´ì—­ì„ ì…ë ¥í•˜ì„¸ìš”..."
                style="width: 100%; padding: 10px; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;"></textarea>

            <div class="row" style="margin-top: 10px; justify-content: flex-end;">
                <button id="applyBtn" class="btn" onclick="applyPrevData()" style="background-color: #666;">ìë£Œ
                    ì ìš©</button>
            </div>
            <div class="info-text" id="prevDataStatus" style="color: #ff4d4f;">* ìë£Œ ì…ë ¥ í›„ 'ìë£Œ ì ìš©' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </div>
        </div>

        <!-- Date & Settings -->
        <div class="section">
            <span class="section-title">2. ìˆ˜ì§‘ ì„¤ì •</span>
            <div class="row" style="margin-bottom: 10px;">
                <span>ğŸ“… ìˆ˜ì§‘ ê¸°ì¤€:</span>
                <strong id="dateDisplay"></strong>
                <span style="font-size: 12px; color: #888;">(ì˜¤ëŠ˜)</span>
            </div>
            <div class="row">
                <span>ìˆ˜ì§‘ ê°œìˆ˜: <strong>3ê°œ</strong> (ê³ ì •)</span>
            </div>
            <div class="info-text">
                * ìˆ˜ì§‘ ë²”ìœ„: ì–´ì œ 20:00 ~ ì˜¤ëŠ˜ 20:00<br>
            </div>
        </div>

        <!-- Controls -->
        <div class="row" style="justify-content: center; margin-bottom: 20px;">
            <button id="startBtn" class="btn" onclick="startCollecting()" disabled style="background-color: #ccc;">ğŸš€ ìˆ˜ì§‘
                ì‹œì‘</button>
            <button id="stopBtn" class="btn stop" onclick="stopCollecting()" disabled>â¹ï¸ ì¤‘ì§€</button>
        </div>

        <!-- Logs -->
        <div class="section-title">ë¡œê·¸</div>
        <div id="logArea" class="log-area"></div>
    </div>

    <script>
        let isRunning = false;
        let stopRequested = false;
        let blogIds = [];
        let isDataApplied = false;

        // Obfuscated Blog IDs (Base64 Encoded)
        // To add new IDs, ask the assistant: "Add [ID] to the list"
        const HARDCODED_IDS_ENCODED = [
            "Y2hhZXdvb25pXzAxMTI=", "YnJhaW5fMTAxOA==", "bXl1bmdfYV8wNzE4", "bWVlbmE3Nw==", "bWVlbmExMjI1",
            "d2pkdGpkZG4wOTE=", "cHBvZmFtaWx5MTI1", "cmVhbG9vX3U=", "dWVvNzc=", "d2pkdGpkZG43Nw==",
            "d2pkdGpkZG4wNzIx", "aGFlbWlsNDAy", "YXJpYXJpNzQ4Ng==", "Ymx1ZXBhbnRzMjc=", "NTIxb2h3NTIx",
            "cmVkcGFudHMyNw==", "aG9uZ2hvbmd3YW5uYQ==", "dmlzaW9uLWJlc3Q=", "Z2JoeTEwMA==", "YWh5b3VuZzEwMw==",
            "d2hpdGU4MDU4", "c3R1ZHk4MDU4", "Y2xsYXJh", "cGhnNDQ2Ng==", "c2Vuc2VxdWVlbg==",
            "Z29kX2JsZXNzeW91NTU2NQ==", "aHNlNzI5", "aGktc29yYQ==", "bGlmZS1uZXh1czc5", "eXVsZF9kdW5n",
            "aGFwcHktc3BhY2Utc2FlbXRlcg==", "c3V5b3VuMTAyMw==", "ZGJma2Q5Mw==", "d2pkZGxhNDAy", "eW9vbnlfbW9tbXk=",
            "d29uczBfMA==", "bWN0aGF0MTMxMzEz", "c2luZ2NjbQ==", "bWFrZWNjbQ==", "dGhvbWFzLTgyNzI=",
            "cHBvZmFtaWx5MTI1"
        ];

        // Decode IDs at runtime
        // Note: Using a Set to automatically remove duplicates (e.g. ppofamily125)
        blogIds = [...new Set(HARDCODED_IDS_ENCODED.map(id => atob(id)))];

        window.onload = function () {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // Better formatting "12ì›”06ì¼"
            const m = (yesterday.getMonth() + 1).toString().padStart(2, '0');
            const d = yesterday.getDate().toString().padStart(2, '0');
            const yesterdayStr = `${m}ì›”${d}ì¼`;

            // document.getElementById('yesterdayLabel').textContent = yesterdayStr;
            document.getElementById('dateDisplay').textContent = today.toISOString().split('T')[0];

            appendLog(`âœ… ê¸°ë³¸ íšŒì› ëª©ë¡ ë¡œë“œ ì™„ë£Œ (ì´ ${blogIds.length}ëª…)`);
            appendLog(`âš ï¸ ${yesterdayStr} í’ˆì•—ì´ ë‚´ì—­ì„ ì…ë ¥í•˜ê³  'ìë£Œ ì ìš©'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
        };

        // Apply Button Logic
        function applyPrevData() {
            const content = document.getElementById('prevDataInput').value.trim();
            if (content.length < 5) {
                alert("ë‚´ìš©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš” (5ê¸€ì ì´ìƒ).");
                return;
            }

            isDataApplied = true;
            document.getElementById('prevDataStatus').textContent = "âœ… ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.";
            document.getElementById('prevDataStatus').style.color = "green";

            // Enable Start Button
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.style.backgroundColor = "#03c75a"; // Restore color

            alert("ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
            appendLog("âœ… ìë£Œê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì§‘ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }

        // Prev Data Input Listener (Reset on change)
        document.getElementById('prevDataInput').addEventListener('input', function (e) {
            if (isDataApplied) {
                isDataApplied = false;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').style.backgroundColor = "#ccc";
                document.getElementById('prevDataStatus').textContent = "* ë‚´ìš©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì ìš©í•´ì£¼ì„¸ìš”.";
                document.getElementById('prevDataStatus').style.color = "#ff4d4f";
            }
        });

        function appendLog(msg) {
            const log = document.getElementById('logArea');
            log.innerHTML += msg + "\n";
            log.scrollTop = log.scrollHeight;
        }

        function stopCollecting() {
            if (isRunning) {
                stopRequested = true;
                appendLog("âš ï¸ ì¤‘ì§€ ìš”ì²­ë¨... (í˜„ì¬ ì‘ì—… ì™„ë£Œ í›„ ì¤‘ì§€)");
            }
        }

        function toggleButtons(running) {
            document.getElementById('startBtn').disabled = running;
            document.getElementById('stopBtn').disabled = !running;
            document.getElementById('prevDataInput').disabled = running;
            document.getElementById('applyBtn').disabled = running;
        }

        async function startCollecting() {
            if (!isDataApplied) { alert("ë¨¼ì € 'ìë£Œ ì ìš©' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”."); return; }
            const _n = new Date();
            if (_n.getHours() < 20) { alert("í’ˆì•—ì´ ë§í¬ ìˆ˜ì§‘ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. ìˆ˜ì§‘ì‹œê°„ì€ ì €ë… 20:00ë¶„~ 23:59ë¶„ ê¹Œì§€ ì…ë‹ˆë‹¤."); return; }

            const _pData = document.getElementById('prevDataInput').value;
            const _excl = parseExcludedIds(_pData);

            if (blogIds.length === 0) { alert("ë¸”ë¡œê·¸ ì•„ì´ë”” ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
            const _tIds = blogIds.filter(id => !_excl.includes(id));

            if (_tIds.length === 0) {
                alert(_excl.length > 0 ? "ëª¨ë“  ì•„ì´ë””ê°€ ë´‰ì‚¬ ê³„ì •(ì œì™¸)ìœ¼ë¡œ ë¶„ë¥˜ë˜ì–´ ìˆ˜ì§‘í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤." : "ìˆ˜ì§‘í•  ì•„ì´ë””ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            isRunning = true;
            stopRequested = false;
            toggleButtons(true);
            document.getElementById('logArea').innerHTML = "";
            appendLog(`ğŸš€ í¬ë¡¤ë§ ì‹œì‘...`);
            appendLog(`- ì „ì²´ ëŒ€ìƒ: ${blogIds.length}ëª…`);
            appendLog(`- ë´‰ì‚¬ ê³„ì •(ìˆ˜ì§‘ ì œì™¸): ${_excl.length}ëª…`);
            if (_excl.length > 0) appendLog(`  (${_excl.join(', ')})`);
            appendLog(`- ê¸ˆì¼ ìˆ˜ì§‘ ëŒ€ìƒ: ${_tIds.length}ëª…`);

            const _cnt = 3;
            const _tDate = new Date(_n);
            const _sTime = new Date(_tDate); _sTime.setDate(_sTime.getDate() - 1); _sTime.setHours(20, 0, 0, 0);
            const _eTime = new Date(_tDate); _eTime.setHours(20, 0, 0, 0);

            appendLog(`ìˆ˜ì§‘ ê¸°ê°„: ${formatDate(_sTime)} ~ ${formatDate(_eTime)}`);

            let _cLinks = [];
            let _cIds = [];

            // Obfuscated Proxy & RSS Logic
            // _0x1 = proxies (first part), _0x2 = RSS base
            const _0x1 = [
                "aHR0cHM6Ly9jb3JzcHJveHkuaW8vPw==",
                "aHR0cHM6Ly9hcGkuYWxsb3JpZ2lucy53aW4vcmF3P3VybD0=",
                "aHR0cHM6Ly9hcGkuY29kZXRhYnMuY29tL3YxL3Byb3h5P3F1ZXN0PQ=="
            ];
            const _0x2 = "aHR0cHM6Ly9yc3MuYmxvZy5uYXZlci5jb20v"; // https://rss.blog.naver.com/

            for (let i = 0; i < _tIds.length; i++) {
                if (stopRequested) { appendLog("ğŸ›‘ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."); break; }
                const _bid = _tIds[i];
                appendLog(`[${i + 1}/${_tIds.length}] ${_bid} í™•ì¸ ì¤‘...`);

                let _ok = false;
                let _err = null;

                for (let k = 0; k < _0x1.length; k++) {
                    if (_ok) break;
                    try {
                        // Decode base + bid + .xml
                        const _rUrl = atob(_0x2) + _bid + ".xml";
                        // Decode proxy + encodeURIComponent(rssUrl)
                        const _fUrl = atob(_0x1[k]) + encodeURIComponent(_rUrl) + `&t=${new Date().getTime()}`;

                        const _ctrl = new AbortController();
                        const _tm = setTimeout(() => _ctrl.abort(), 5000);

                        const _res = await fetch(_fUrl, { signal: _ctrl.signal });
                        clearTimeout(_tm);

                        if (!_res.ok) throw new Error(`HTTP ${_res.status}`);

                        const _txt = await _res.text();
                        if (!_txt.includes("<rss") && !_txt.includes("<feed")) throw new Error("Invalid XML");

                        const _xml = new DOMParser().parseFromString(_txt, "text/xml");
                        const _items = _xml.getElementsByTagName("item");
                        let _vPosts = [];

                        for (let j = 0; j < _items.length; j++) {
                            const _it = _items[j];
                            const _pDt = _it.getElementsByTagName("pubDate")[0]?.textContent;
                            const _lt = _it.getElementsByTagName("link")[0]?.textContent;

                            if (_pDt && _lt) {
                                const _pd = new Date(_pDt);
                                if (_pd >= _sTime && _pd < _eTime) {
                                    let _ml = _lt.replace("://blog.naver.com/", "://m.blog.naver.com/");
                                    _vPosts.push({ d: _pd, u: _ml, i: _bid });
                                }
                            }
                        }

                        _vPosts.sort((a, b) => b.d - a.d);
                        const _fin = _vPosts.slice(0, _cnt);

                        if (_fin.length > 0) {
                            appendLog(`  - âœ… ${_fin.length}ê°œ í¬ìŠ¤íŒ… ë°œê²¬`);
                            _fin.forEach(p => _cLinks.push(p.u));
                            if (!_cIds.includes(_bid)) _cIds.push(_bid);
                        } else {
                            appendLog(`  - í•´ë‹¹ ê¸°ê°„ í¬ìŠ¤íŒ… ì—†ìŒ`);
                        }
                        _ok = true;

                    } catch (e) { _err = e.message; }
                }

                if (!_ok) appendLog(`  - âŒ ìˆ˜ì§‘ ì‹¤íŒ¨ (ëª¨ë“  í”„ë¡ì‹œ ì‹œë„ ì‹¤íŒ¨): ${_err}`);
                await new Promise(r => setTimeout(r, 1000));
            }

            if (_cLinks.length > 0) {
                downloadFiles(_cLinks, _cIds, _excl);
            } else {
                if (!stopRequested) alert("ìˆ˜ì§‘ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. (ê¸°ê°„ ë‚´ í¬ìŠ¤íŒ… ì—†ìŒ)");
            }

            isRunning = false;
            toggleButtons(false);
            appendLog("âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ");
        }

        // Parse extracted IDs from the pasted text
        function parseExcludedIds(text) {
            const lines = text.split('\n');
            const ids = [];
            for (let line of lines) {
                // Match lines like "1. brain_1018" or just "brain_1018"
                // Remove leading numbers digits + dot + space
                let cleaned = line.replace(/^\d+\.\s*/, '').trim();
                // If it looks like a valid ID (alphanumeric + underscore/hyphen, simple validation)
                if (cleaned && /^[a-zA-Z0-9_-]+$/.test(cleaned)) {
                    ids.push(cleaned);
                }
            }
            return ids;
        }

        function formatDate(d) {
            return d.toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        function downloadFiles(links, collectedIds, excludedIds) {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = (now.getMonth() + 1).toString().padStart(2, '0');
            const dd = now.getDate().toString().padStart(2, '0');
            const dateStr = `${yyyy}${mm}${dd}`;

            // 1. Link File
            const linkContent = links.join("\n");
            downloadTextFile(linkContent, `ë§í¬ìˆ˜ì§‘${dateStr}.txt`);
            appendLog(`ğŸ’¾ ë§í¬ íŒŒì¼ ì €ì¥ ì™„ë£Œ (ì´ ${links.length}ê°œ)`);

            // 2. ID File (New Format)
            const formattedDate = `${yyyy}ë…„ ${mm}ì›” ${dd}ì¼`;
            const totalCount = collectedIds.length;

            let idContent = `${formattedDate} ì°¸ì—¬ì•„ì´ë””\n`;
            idContent += `ì´ ì°¸ì—¬ ì•„ì´ë”” : ${totalCount}ê°œ\n`;
            idContent += `ë´‰ì‚¬ ì•„ì´ë”” : ${excludedIds.length}ê°œ\n\n`;

            idContent += `ê¸ˆì¼ ë´‰ì‚¬ ê³„ì •\n`;
            if (excludedIds.length > 0) {
                excludedIds.forEach((id, idx) => {
                    idContent += `${idx + 1}. ${id}\n`;
                });
            } else {
                idContent += `(ì—†ìŒ)\n`;
            }
            idContent += `\n`;

            idContent += `ê¸ˆì¼ í’ˆì•—ì´ ê³„ì •\n`;
            collectedIds.forEach((id, idx) => {
                idContent += `${idx + 1}. ${id}\n`;
            });

            downloadTextFile(idContent, `${dateStr}ì°¸ì—¬ì•„ì´ë””.txt`);
            appendLog(`ğŸ’¾ ì°¸ì—¬ì•„ì´ë”” íŒŒì¼ ì €ì¥ ì™„ë£Œ`);
        }

        function downloadTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>
